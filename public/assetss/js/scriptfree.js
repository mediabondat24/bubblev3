var array_doa = [
    "tahun ini bisa umroh","rezekinya lancar","dijauhkan dari marabahaya","suatu saat nanti punya usaha koskosan","tahun ini kebeli mobil","semakin kuat dalam menghadapi kehidupan","mendapat rezeki yang melimpah","selalu bahagia bersama pasangan kamu","tahun ini lebih hoki lagi","selalu dilimpahkan kebahagiaan","bisa umrohkan orang tua",
    "ditahun ini semua impianmu terwujud","taun depan punya rumah baru","besok ada yang ngajak jalan","segera mendapatkan apa yang kamu impikan","hari ini ada yang traktir","tahun 2024 lebih baik lebih bahagia","diberikan kesehatan dan kekuatan","dilancarkan usahanya","diberikan keberuntungan dan keberkahan","selalu bahagia bersama dirinya",
    "bulan depan punya motor baru","naik gaji","minggu depan punya iPhone","besok ada yang ngasih hadiah","menjadi orang yang sukses","kebeli sawah berhektarhektar","segera dapat kerjaan lebih baik","bisa jalan-jalan keluar negeri","bulan depan ada yang ngajak traveling","minggu depan kebeli sekupi","segera punya hape baru",
    "apayang dicitacitakan bisa segera tercapai","besok ada yang ngajak hiling","segera punya sepatu baru","besok diangkat jadi sodara RafiAhmad","diberikan rizki yang melimpah","selalu dipertemukan dengan orang baik","selalu dicintai pasangan","besok ada yang ngajak liburan","diberikan kemudahan segala urusannya","makin lancar rezekinya",
    "lelahmu menjadi lillah","besok ada yang ngajak ngabuburit","ada yang ngasih THR","suatu saat jadi sultan","suatu saat nanti jadi pengusaha sukses","kehidupanmu menjadi lebih sukses lagi","suatu saat nanti bisa merasakan apa yang RafiAhmad rasakan","panjang umur dan sehat selalu","kebeli tanah berhektarhektar",
    "suatu saat nanti punya usaha cucian mobil","suatu saat nanti punya rumah mewah","hutangmu ada yang lunasi","besok yang ngajak shoping","suatu saat nanti punya mobil alpard","dilancarkan usaha dan aktivitasnya","punya kontrakan 10 pintu","diberikan keturunan yg soleh dan solehah","selalu dikelilingi orang-orang baik dan tulus",
    "mendapatkan pekerjaan yang membahagiakan dan memuaskan","diberikan kesehatan mental yang baik","suatu saat bisa berkeliling dunia","memiliki kehidupan yang penuh syukur dan berkah","mendapatkan teman yang bisa diajak berbagi suka dan duka","mampu membangun keluarga yang harmonis dan bahagia","mendapatkan peningkatan karier yang lebih baik",
    "selalu diberi kelancaran dalam berbisnis","suatu saat nanti memiliki yayasan amal","rezeki yang selalu berkecukupan dan cukup untuk berbagi","selalu diberikan ketenangan hati dalam setiap masalah","mendapatkan promosi di tempat kerja","selalu dilindungi dalam setiap perjalanan","diberikan kesempatan untuk belajar ilmu agama lebih dalam",
    "selalu dimudahkan dalam segala urusan keuangan","mampu membahagiakan keluarga dan orang tua","selalu diberi kekuatan untuk membantu sesama","menjadi pribadi yang lebih sabar dan penyayang","dijauhkan dari segala bentuk kecelakaan dan bencana","selalu diberkahi dengan kesehatan tubuh dan jiwa","diberikan kesempatan beribadah dengan khusyuk",
    "mendapatkan rezeki yang tak disangka-sangka","selalu dilimpahkan kedamaian dalam rumah tangga","mampu menjadi orang yang selalu rendah hati","selalu diberi jalan keluar dalam setiap kesulitan","menjadi panutan dan inspirasi bagi orang lain","selalu dikelilingi cinta dan kasih sayang","diberikan kemampuan untuk mendidik anak-anak dengan baik",
    "selalu diberi petunjuk dalam menjalani kehidupan","mampu menjalankan bisnis yang sukses dan berkah","mendapatkan pasangan yang setia dan penuh perhatian","selalu dijauhkan dari rasa iri dan dengki","selalu bisa memberi manfaat bagi banyak orang","diberi kemampuan mengontrol emosi dan ego","mampu menjalani hidup yang penuh kesederhanaan",
    "diberikan rezeki halal yang melimpah","selalu dalam lindungan Allah SWT dalam setiap langkah","mendapatkan kesempatan untuk berbakti lebih kepada orang tua","suatu saat nanti memiliki tanah dan kebun sendiri","selalu menjadi sumber kebahagiaan bagi orang lain","dijauhkan dari segala bentuk kesialan","diberi kesempatan untuk memperbaiki diri setiap hari",
    "mendapatkan kemudahan dalam membayar hutang","dijauhkan dari teman-teman yang membawa pengaruh negatif","diberikan kelancaran dalam menghafal ayat-ayat suci","selalu disayangi oleh orang-orang di sekitar","mampu menjaga hubungan yang harmonis dengan keluarga","selalu diberi kepercayaan dalam setiap tanggung jawab",
    "diberikan kemudahan dalam menyelesaikan pekerjaan dan tanggung jawab"
  ];

  var array_sambutan = [
    "yang tercinta", "yang suka ngambek","yang lagi pengen jajan","yang kuat  kokoh dan terpercaya","yang kalau mandi sekali sehari","yang terindah dan tersayang", "yang sangat lucu", "yang sangat imut", "yang super cakep","yang masih jomblo haha","yang selalu dimanja nenek","yang selalu merindukan dia",
    "yang mempesona", "yang sedikit agak galak","yang suka sama host","yang jutek banget","yang lagi males ngomong" ,"yang mungil dan lucu","yang kalau lagi seneng suka lupain dia", "yang baik hati dan tidak sombong", "yang pintar merayu","yang saat ini sedang buka tiktok","kamu kemana aja?","yang citacitanya jadi orang kaya",
    "yang terhebat", "yang menawan nan rupawan", "yang sungguh aduhai","yang sedang menunggu jodoh","situkang bucin","yang masih suka ngompol","yang super seksi", "yang sangat cerdas","yang hanya ingin disayangi","yang selalu nurut apa kata orang tua","situkang gosting","yang hobinya tidur mulu","yang suka kabur kalau ditagih hutang",
    "yang baik hati","yang kalau makan bakso 2 mangkok","yang kalau tidur masih dikelonin", "yang cabi", "yang gemoy", "yang manis", "yang tersayang","yang punya hati yang tulus","yang merindukan dia dan dirinya","yang suka ngegosip","yang pinter ngegombal","jagon mamah",
    "yang super hebat","yang sedang memikirkan seseorang", "yang rajin menabung", "yang kalau makan ga cukup 2 piring","yang sopan dan santun","yang ingin punya pacar","yang masih cinta sama mantan","yang ingin diperhatikan","yang jarang mandi","yang masih sendiri","yang alergi kalau ga punya uang",
    "kesayangan mamah","yang lagi laper", "idaman mertua","kesayangan papah","yang sedang memikirkan masa depan", "kesayangan pacar","yang selalu galau","sipenakluk cinta","yang selalu merindu","yang masih kepoin mantan","yang punya kapal pesiar","bolehkan pinjem seratus","yang hobinya jajan seblak",
    "kesayangan mantan","yang sedang galau", "kesayangan keluarga","siraja gombal","yang kalau jajan suka lupa bayar", "yang tangguh dan kuat","yang selalu tersakiti","yang pinter ngomong","yang selalu gabut","yang selalu memaafkan","situkang makan","yang masih suka sama mantan",
    "yang rajin dan pandai","kesayangan nene","yang manja","yang baik hati","yang dermawan","yang dirindukan","yang dicintai umat manusia","yang cakep ga ada obat","pinjem seratus dulu bisa kali","yang belum mandi dari tadi pagi","yang rajin ibadah","kembanggan orang tua",
    "yang mageran","yang kalau makan 3 ngaku 2","yang marahmarah terus","yang disayangi pacar","kamu apa kabar?","yang ingin kawin lagi","yang suka jajan sembarangan","yang selalu bahagia"," yang cantiknya kebangetan","yang suka jajan sembarangan","yang sedang memikirkan aku","yang rajin bekerja",
    "yang selalu nyari colokan kalau baterai low","yang tiap buka dompet selalu kaget","yang pengen liburan tapi mager keluar rumah","yang tiap malam mingguan nonton film","yang ngakunya bisa masak tapi cuma mie instan","yang selalu bilang 'bentar lagi' tapi kelamaan","yang suka kepoin medsos mantan",
    "yang tiap lihat postingan makan langsung lapar","yang kalau makan pakai saus banyak banget","yang sering bilang 'besok mulai nabung'","yang tiap liburan pengennya tidur","yang suka bilang 'nanti aja' kalau ditagih kerjaan","yang kalau beli baju harus diskon","yang selalu update story tiap hari",
    "yang paling cerewet kalau minta foto ulang","yang ngakunya pinter tapi suka bingung","yang nggak bisa lepas dari cemilan","yang tiap pagi ngeluh ngantuk","yang selalu bawa skincare kemana-mana","yang hobinya ngegalauin hidup","yang tiap kali selfie ambil 50 foto","yang suka bilang 'aku laper' tiap jam",
    "yang ngaku-ngaku jago masak","yang paling susah bangun pagi","yang kalau ada masalah bilangnya 'yaudah lah'","yang tiap malam stalking orang","yang suka koleksi parfum tapi pakainya satu","yang kalau ngantuk suka ngigo","yang sering lupa bawa payung","yang ngakunya benci hujan tapi suka nyanyi di bawah hujan",
    "yang paling jago scroll medsos","yang suka tiba-tiba galau","yang kalau weekend maunya di rumah aja","yang nggak bisa tahan lihat makanan enak","yang tiap hari bilang 'males banget'","yang selalu bawa tisu kemana-mana","yang tiap ketemu teman bilang 'kangen banget'","yang suka update foto makanan",
    "yang tiap nonton film pasti nangis","yang selalu bilang 'gue diet' tapi makan terus","yang hobinya download aplikasi gratis","yang paling semangat kalau ada gratisan","yang suka bilang 'mager banget'","yang tiap hari bilang 'aduh capek banget'","yang suka ketawa sendirian lihat chat","yang selalu bawa power bank gede",
    "yang kalau ke mall paling hobi window shopping","yang suka main game sampai lupa waktu","yang selalu bilang 'ini terakhir' saat makan","yang hobinya screenshot chat orang","yang kalau lihat drama pasti ikut marah-marah","yang suka lupa bawa kacamata","yang paling jago bikin status galau",
    "yang selalu bawa hand sanitizer kemana-mana","yang kalau makan pedes nangis","yang kalau selfie pasti pake filter","yang tiap ketemu bilang 'kangen banget'","yang kalau nonton konser paling depan","yang paling ribet urusan outfit","yang tiap lihat promo langsung checkout","yang ngakunya low budget tapi belanja terus",
    "yang suka ketawa ngakak kalau lihat video lucu","yang paling jago bikin meme","yang suka bawa bekal nasi kotak kemana-mana","yang kalau ketawa kenceng banget","yang tiap malam begadang scroll timeline","yang suka banget minum kopi","yang tiap ngumpul selalu cerita yang sama","yang nggak bisa jauh dari air putih",
    "yang tiap buka kulkas nyari cemilan","yang suka lupa naruh HP","yang kalau belanja nggak pernah cukup satu kantong","yang suka pake emot lucu-lucu","yang sering ngeluh nggak punya uang","yang hobi banget cerita panjang","yang kalau pergi keluar lupa bawa jaket","yang suka bilang 'ah pengen tidur' tiap siang",
    "yang sering bilang 'gue kuat kok' padahal rapuh","yang ngakunya hemat tapi suka boros","yang hobinya ngegibah online","yang nggak bisa lihat sesuatu lucu tanpa beli","yang suka ngeluh malas kerja","yang paling jago rebutan diskon","yang kalau dikasih tugas sering lupa","yang ngakunya sibuk padahal gabut",
    "yang tiap hari bilang 'gue capek banget'","yang nggak bisa tidur tanpa peluk bantal","yang suka lihat review makanan online","yang kalau lihat sesuatu mahal langsung galau","yang nggak bisa lepas dari social media","yang suka banget cari diskon online","yang ngakunya pendiam tapi sering curhat panjang",
    "yang paling jago menghindari utang","yang nggak bisa lepas dari es kopi","yang selalu pengen jadi influencer","yang hobinya bikin video lucu","yang selalu bilang 'ah nanti aja'","yang paling banyak nonton video unboxing","yang tiap hari nyari quotes motivasi","yang nggak bisa jauh dari charger",
    "yang kalau makan selalu pesan ekstra sambal","yang sering bilang 'gue nggak posesif kok' tapi ngecek terus","yang kalau denger musik suka joget sendiri","yang hobinya koleksi barang unik","yang tiap ketemu teman lama bilang 'wah makin gendut ya'","yang suka belanja kado buat diri sendiri",
    "yang suka koleksi kaos kaki lucu","yang selalu lupa password akun","yang tiap ada acara bilang 'nggak punya baju'"
];


// This will use the demo backend if you open index.html locally via file://, otherwise your server will be used
let backendUrl = location.protocol === 'file:' ? "https://tiktok-chat-reader.zerody.one/" : undefined;
let connection = new TikTokIOConnection(backendUrl);

// Counter
let viewerCount = 0;
let likeCount = 0;
let diamondsCount = 0;

// These settings are defined by obs.html
if (!window.settings) window.settings = {};
window.addEventListener('DOMContentLoaded', (event) => {
      // Menunggu halaman dimuat, lalu tampilkan modal
      var myModal = new bootstrap.Modal(document.getElementById('basicModal'));
      myModal.show();  // Tampilkan modal secara otomatis
    });

$(document).ready(() => {
    $('#connectButton').click(connect);
    $('#uniqueIdInput').on('keyup', function (e) {
        if (e.key === 'Enter') {
            connect();
        }
    });

    if (window.settings.username) connect();
})


function connect() {
   let uniqueId = window.settings.username || $('#uniqueIdInput').val();
    
    
    if (uniqueId !== '') {
        
        $('#stateText').text('Mohon tunggu jangan klik apapun dulu...');

        connection.connect(uniqueId, {
            enableExtendedGiftInfo: true
        }).then(state => {
            $('#stateText').text(`Berhasil dikoneksikan`);
            
            aktifSuara("Berhasil di koneksikan ke akun "+uniqueId);
            
           // Only request fullscreen if not already in fullscreen
      if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
        setTimeout(() => {
          toggleFullScreen();  // Make fullscreen after modal is fully closed
        }, 200);  // Delay a little to ensure fullscreen is applied
      }

      $('#basicModal').modal('hide');  // Hide the modal after fullscreen

      // Scroll to top after modal closes
      $('#basicModal').on('hidden.bs.modal', function () {
        window.scrollTo(0, 0);  // Scroll to top after modal is fully closed
      });


            viewerCount = 0;
            likeCount = 0;
            diamondsCount = 0;
            updateRoomStats();

        }).catch(errorMessage => {
            if(errorMessage=="Error: LIVE has ended"){
                $('#stateText').html("Gagal! tiktok <b>"+uniqueId+"</b> harus dalam keadaan LIVE.");
            }else if(errorMessage=="Error: Request failed with status code 429"){
                $('#stateText').text("Mohon maaf server sedang gangguan silahkan coba beberapa saat lagi. ");
            }else if(errorMessage=="Error: Request failed with status code 500"){
                $('#stateText').text("Mohon maaf server sedang gangguan silahkan coba beberapa saat lagi. ");
            }else{
                $('#stateText').text(errorMessage);
            }

            // schedule next try if obs username set
            if (window.settings.username) {
                setTimeout(() => {
                    connect(window.settings.username);
                }, 30000);
            }
        })

    } else {
        alert('no username entered');
    }
}
// Prevent Cross site scripting (XSS)
function sanitize(text) {
    return text.replace(/</g, '&lt;')
}

function updateRoomStats() {
    $('#roomStats').html(`Viewers: <b>${viewerCount.toLocaleString()}</b> Likes: <b>${likeCount.toLocaleString()}</b> Earned Diamonds: <b>${diamondsCount.toLocaleString()}</b>`)
}

function generateUsernameLink(data) {
    return `<a class="usernamelink" href="https://www.tiktok.com/@${data.uniqueId}" target="_blank">${data.uniqueId}</a>`;
}

function isPendingStreak(data) {
    return data.giftType === 1 && !data.repeatEnd;
}

// Logika untuk menambah chat item dengan foto profil kecil
function addChatItem(color, data, text, summarize='',komen=false) {
    return false;
    const inputString = sanitize(text);
    let container = location.href.includes('obs.html') ? $('.eventcontainer') : $('.chatcontainer');
      
    if (container.find('div').length > 500) {
        container.find('div').slice(0, 200).remove();
    }

    container.find('.temporary').remove();


if(komen==false || komen=="joined" || komen==""){
    var hasil = ""; var awalan = "";
}else{
        aktifSuaraKomen(data.comment);

}
    container.prepend(`
        <div    class=${summarize ? 'temporary' : 'static'}>
         <a target="new" href="javascript:ganti_bg('"${data.profilePictureUrl}"')">
            <img class="miniprofilepicture" src="${data.profilePictureUrl}">
            <span>
                <b>${generateUsernameLink(data)}</b>
                ${awalan} : <span style="color:${color}">${sanitize(text)}</span>  <i>${hasil}</i>
            </span>
        </a>    
        </div>
    `);
}

// Fungsi untuk menambah gambar profil saat gift diberikan, ukuran sesuai diamond
function addGiftItem(data) {
   
}

function moveRandomly(element) {
    const container = document.getElementById("profileContainer");
    const moveInterval = 5000; // Interval perpindahan setiap 5 detik
    const duration = 60000; // Durasi total perpindahan (60 detik)
    const isMobile = window.innerWidth < 768; // Deteksi perangkat mobile berdasarkan lebar layar

    function setInitialPositionWithSlideAndScatter() {
        const containerWidth = container.offsetWidth;
        const containerHeight = container.offsetHeight;
        const elementWidth = element.offsetWidth;
        const elementHeight = element.offsetHeight;

        // Hitung posisi acak di dalam layar
        const randomX = Math.random() * (containerWidth - elementWidth);
        const randomY = Math.random() * (containerHeight - elementHeight);

        // Set posisi awal di pojok kiri atas
        element.style.top = `0px`;
        element.style.left = `0px`;

        // Terapkan kelas animasi dan posisi acak jika di Android
        if (isMobile) {
            element.classList.add('slide-and-scatter');
            setTimeout(() => {
                element.style.top = `${randomY}px`;
                element.style.left = `${randomX}px`;
            }, 10); // Mulai perpindahan setelah elemen di-render

            // Hapus kelas animasi setelah selesai agar bisa melanjutkan gerakan bebas
            setTimeout(() => {
                element.classList.remove('slide-and-scatter');
            }, 1000); // Durasi animasi slide-and-scatter
        } else {
            // Set posisi acak langsung tanpa animasi untuk desktop
            element.style.top = `${randomY}px`;
            element.style.left = `${randomX}px`;
        }
    }

    function setRandomPosition() {
        const containerWidth = container.offsetWidth;
        const containerHeight = container.offsetHeight;
        const elementWidth = element.offsetWidth;
        const elementHeight = element.offsetHeight;

        const randomX = Math.random() * (containerWidth - elementWidth);
        const randomY = Math.random() * (containerHeight - elementHeight);

        element.style.top = `${randomY}px`;
        element.style.left = `${randomX}px`;
    }

    setInitialPositionWithSlideAndScatter();

    const intervalId = setInterval(setRandomPosition, moveInterval);

    setTimeout(() => {
        clearInterval(intervalId);
        element.classList.add('fade-out');
    }, duration);

    setTimeout(() => {
        element.remove();
    }, duration + 2000);
}


// Event handlers
connection.on('roomUser', (msg) => {
    if (typeof msg.viewerCount === 'number') {
        viewerCount = msg.viewerCount;
        updateRoomStats();
    }
})

connection.on('like', (msg) => {
    if (typeof msg.totalLikeCount === 'number') {
        likeCount = msg.totalLikeCount;
        updateRoomStats();
    }

    if (window.settings.showLikes === "0") return;

    if (typeof msg.likeCount === 'number') {
    //    addChatItem('#447dd4', msg, msg.label.replace('{0:user}', '').replace('likes', `${msg.likeCount} likes`),"","joined");
    addBubble("small",msg.profilePictureUrl);
    }
})

// Member join
var urut_sifat=0;
let joinMsgDelay = 0;
connection.on('member', (msg) => {
    if (window.settings.showJoins === "0") return;

    let addDelay = 250;
    if (joinMsgDelay > 500) addDelay = 100;
    if (joinMsgDelay > 1000) addDelay = 0;

    joinMsgDelay += addDelay;

        joinMsgDelay -= addDelay;
        // addChatItem('#21b2c2', msg, 'joined', true,"joined");
        addBubble("small",msg.profilePictureUrl);
       
      
        
        
        let jumlahElemen = array_sambutan.length;
       if(urut_sifat>=(jumlahElemen-1)){
        urut_sifat=1;
       }else{
        urut_sifat++;
       }
       var sifat =  array_sambutan[urut_sifat];
       var string = msg.nickname;
       var nama = string.replace(/[^a-zA-Z]/g, '');

       var opsi = $("#opsi_suara").val();
       if(opsi==1){
           aktifSuara("halo kak "+nama+" "+sifat,"join");
       }else{
           aktifSuara("selamat bergabung kak "+nama,"join");
       }

})

// New chat comment received
connection.on('chat', (msg) => {
    if (window.settings.showChats === "0") return;
  //  gift(msg.profilePictureUrl,msg.nickname,false,false,"chat",msg.comment);
   // addChatItem('', msg, msg.comment,'',true);
     aktifSuaraKomen(msg.comment);
            // openPopupTab(``,`${msg.comment}`);
            addBubble("small",msg.profilePictureUrl);
            addBubble("small",msg.profilePictureUrl);
           
})

// New gift received
var urut_doa = 0;
connection.on('gift', (data) => {
    if (!isPendingStreak(data) && data.diamondCount > 0) {
        diamondsCount += (data.diamondCount * data.repeatCount);
        updateRoomStats();
    }

    if (window.settings.showGifts === "0") return;

   

    if (!data.repeatEnd) {
        
   
    if(data.diamondCount<=5){
        
        for(i=1;i<=data.diamondCount;i++)
        {
            addBubble("medium",data.profilePictureUrl,data.diamondCount);
       
        }
        
    
        
        
    }else if(data.diamondCount<=10){
onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        for(i=1;i<=5;i++)
        {
            addBubble("medium",data.profilePictureUrl,data.diamondCount); 
        }
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
         
        for(i=1;i<=5;i++)
        {
            addBubble("small",data.profilePictureUrl);
        }
        musicFile = "/music/meledak.mp3";
    }else if(data.diamondCount<=20){
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);

        for(i=1;i<=5;i++)
        {
            addBubble("medium",data.profilePictureUrl,data.diamondCount); 
        }
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount);  
         
        for(i=1;i<=20;i++)
        {
            addBubble("small",data.profilePictureUrl);
        }
        //supersmall
        addBubble("supersmall",data.profilePictureUrl,data.diamondCount);
        addBubble("supersmall",data.profilePictureUrl,data.diamondCount);
        musicFile = "/music/tangtingtung.mp3";
    }else if(data.diamondCount<=30){
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        for(i=1;i<=5;i++)
        {
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
        
  

        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount); 

       
    
         
        for(i=1;i<=25;i++)
        {
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount);
        }
        musicFile = "/music/ani.mp3";
    }else if(data.diamondCount<=50){
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        for(i=1;i<=10;i++)
        {
             addBubble("large",data.profilePictureUrl,data.diamondCount); 
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
      
        
           
        
        
        for(i=1;i<=40;i++)
        {
 
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount); 
        }
        musicFile = "/music/ani.mp3";
         
    }else if(data.diamondCount<=100){
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        for(i=1;i<=20;i++)
        {
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
        
        for(i=1;i<=15;i++)
        {
             addBubble("large",data.profilePictureUrl,data.diamondCount);  
        }
        
        
                
        
        
        for(i=1;i<=40;i++)
        {
            
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount); 
        }
        
         musicFile = "/music/apantuh.mp3";
    }else if(data.diamondCount<=300){
        
          onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);        
                    
        for(i=1;i<=25;i++)
        {
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
        
        for(i=1;i<=20;i++)
        {
             addBubble("large",data.profilePictureUrl,data.diamondCount);  
        }
        
         
        
        
        for(i=1;i<=40;i++)
        {
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount); 
        }
        musicFile = "/music/sadbor.mp3";
         
    }else{
        
         onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
                   
                    
       for(i=1;i<=35;i++)
        {
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
        
        
                 
        
        for(i=1;i<=30;i++)
        {
             addBubble("large",data.profilePictureUrl,data.diamondCount);  
        }
       
        
        for(i=1;i<=50;i++)
        {
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount); 
        }
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true);
        musicFile = "/music/sadbor.mp3";
    }


    playGiftMusic(musicFile);
     

      let jumlahElemen = array_doa.length;
      if(urut_doa>=(jumlahElemen-1)){
        urut_doa=1;
      }else{
        urut_doa++;
      }
      var doa= array_doa[urut_doa];

      var string = data.nickname;
      var nama = string;//.replace(/[^a-zA-Z]/g, '');


      var opsi = $("#opsi_suara").val();
      if(opsi==1){
        aktifSuara("Terimakasih kak "+nama+"  sudah kasih "+data.giftName+" semoga "+doa+".","gift");
      }else{
        aktifSuara("Terimakasih kak "+nama+"  sudah kasih "+data.giftName+" semoga berkah","gift");
      }


          
    




        }     
})

// share, follow
connection.on('social', (data) => {
    if (window.settings.showFollows === "0") return;

    let color = data.displayType.includes('follow') ? '#ff005e' : '#2fb816';
    if(color=='#ff005e'){
        aktifSuara("Terimakasih kak "+data.nickname+"  sudah jadikan aku teman","follow");
        addBubble("small",data.profilePictureUrl);
    }else{
        aktifSuara("Terimakasih kak "+data.nickname+"  sudah sherr","share");
        addBubble("small",data.profilePictureUrl);
    }
 
})



connection.on('streamEnd', () => {
    $('#stateText').text('Stream ended.');

    // schedule next try if obs username set
    if (window.settings.username) {
        setTimeout(() => {
            connect(window.settings.username);
        }, 30000);
    }
})





function toggleBlur(image) {
            image.classList.toggle('blurred');
        }

setTimeout(() => {
  openmodal();
  // masukanpoto();

}, 500);

function masukanpoto(){
  var img = "https://img.freepik.com/premium-vector/tik-tok-logo_578229-290.jpg";
  addBubble("small",img);
  addBubble("small",img);
  addBubble("small",img);
 
}
function tutupmodal(){
 
  scrollToTop();
  $("#addBubbleModal").modal("hide");
  petunjuk();
}
function petunjuk(){

  setTimeout(() => {
    $("#petunjuk").hide(3000);
  }, 6000);
  setTimeout(() => {
    masukanpoto();
  }, 4000);
   
}

    function toggleFullScreen() {
            const doc = window.document;
            const docEl = doc.documentElement;

            const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
            const exitFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

            if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                requestFullScreen.call(docEl);
            } else {
                exitFullScreen.call(doc);
            }
        }
     

       
var no =1;
var jawab = "xmxmxmmx";
var alias = "xmxmxmmx";
var koin=0;
var mode = "soal";

 
$(".chatcontainer").show();
$(".chatcontainer2").hide();
$(".chatcontainer3").hide();
function jawaban(komentar,poto,nama){
     
  
} 

 var ganti=true;
 
 function okey(foto,nama,g=false){
   
   
        $("#namas").html(nama);
        var element = document.getElementById("g");
        element.src= foto;  
         
        
 }

 function bahaya(){
  var element = document.getElementById("g");
        element.src= "https://img.freepik.com/premium-vector/tik-tok-logo_578229-290.jpg"; 
 }
 
 
      var start=true;
      
      function jo(){
         if(start==true){
             start=false;
         }else{
               start=true;
         }
      }

    function hapus_class(){
      $("#g").hide(300);
      $("#g").show(1000);
    }  

    function add_class(){
      $("#g").hide(300);
      $("#g").show(1000);
    }  
      
     function gift(foto,nama,sts=false,g=false,ket=null,kom=null,jml_coin=1){
      var gift = document.getElementById("gift");
if (gift.checked) {
  var opsi_gift = true;
} else {
  var opsi_gift = false;
}

var follow = document.getElementById("follow");
if (follow.checked) {
  var opsi_follow = true;
} else {
  var opsi_follow = false;
}

var share = document.getElementById("share");
if (share.checked) {
  var opsi_share = true;
} else {
  var opsi_share = false;
}

var like = document.getElementById("like");
if (like.checked) {
  var opsi_like = true;
} else {
  var opsi_like = false;
}

var join = document.getElementById("join");
if (join.checked) {
  var opsi_join = true;
} else {
  var opsi_join = false;
}
var key = document.getElementById("key");
if (key.checked) {
  var opsi_key = true;
} else {
  var opsi_key = false;
}

 
         if(sts==true && ganti==true){
          console.log("jml"+jml_coin);
        var min_coin = $("[name='min_coin']").val();
        console.log("min"+min_coin);
     

          if(jml_coin>=min_coin){
                ganti=false;
                if(opsi_gift==true){
                  
                  add_class();

                  okey(foto,nama,g); 
                  setTimeout(() => {
                                    ganti=true;
                      },7000);
                      return true;
                }else{
                  ganti=true;
                }
            }
                
         }
         
          if(sts==true && ganti==false){ 
            console.log("jml"+jml_coin);
var min_coin = $("[name='min_coin']").val();
console.log("min"+min_coin);


            if(jml_coin>=min_coin){
              if(opsi_gift==true){
                add_class();

                  setTimeout(() => {
                        okey(foto,nama,g); 
                  
                    },5000);
                    
                    setTimeout(() => {
                                  ganti=true;
                    },10000);
                  }else{
                    ganti=true;
                  }
              }
               
          }
          
    if(ket=="like" && opsi_like==true)      
    {      
            if(sts==false && ganti==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }

   else if(ket=="share" && opsi_share==true)      
    {      
            if(sts==false && ganti==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }

   else if(ket=="follow" && opsi_follow==true)      
    {      
            if(sts==false && ganti==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }
    else if(ket=="join" && opsi_join==true)      
    {      
            if(sts==false && ganti==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }
    else if(ket=="chat" && opsi_key==true)      
    {      
      var komentar_system = kom;
           var komen_status = false;
             var keyword = $("[name='komentar']").val();
              const isKeywordExists = komentar_system.toLowerCase().includes(keyword.toLowerCase());
              if(isKeywordExists!=false){ 
                var komen_status = true;
              }else if(keyword==""){
                var komen_status = true;
              }
            if(sts==false && ganti==true && komen_status==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }
     
     }
         
    let photoCount = 0;
    let speed = 5000; // Kecepatan default, diatur dalam milidetik

    function addBubble(size,img,coint=1) {



      const photo = document.createElement('img');
      photo.src = img; // Ganti dengan nama foto Anda
      photo.classList.add('photo');
      // photo.id = `photo-${photoCount}`;
      photo.id = `photo-${photoCount}`;
      photo.setAttribute('onclick', 'toggleBlur(this)');
      // document.getElementById('animation-container').appendChild(photo);

const container = document.getElementById('animation-container');
container.appendChild(photo);

      let durationInput;
   
    
    if (size === 'small') {
        photo.style.width = '50px';
        photo.style.height = '50px';
        durationInput = document.getElementById('smallDuration');
        var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;

      } else if (size === 'medium') {
        photo.style.width = '120px';
        photo.style.height = '120px';
        durationInput = document.getElementById('mediumDuration');
        photo.style.zIndex = coint;
        var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        photo.style.boxShadow = '0 0 10px ' + randomColor;
      }else if (size === 'large') {
        photo.style.width = '250px';
        photo.style.height = '250px';
        durationInput = document.getElementById('largeDuration');
        photo.style.zIndex = coint+1;
        var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        photo.style.boxShadow = '0 0 10px ' + randomColor;

      }else if (size === 'supermedium') {
        photo.style.width = '120px';
        photo.style.height = '120px';
        photo.style.borderRadius = '240px';
        durationInput = document.getElementById('mediumDuration');
        photo.style.zIndex = coint;
       var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        photo.style.boxShadow = '0 0 10px ' + randomColor;
      }else if (size === 'supersmall') {
        photo.style.width = '70px';
        photo.style.height = '70px';
        photo.style.borderRadius = '240px';
        durationInput = document.getElementById('smallDuration');
        photo.style.zIndex = coint;
        var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        photo.style.boxShadow = '0 0 10px ' + randomColor;
      }
      
      const fadeoutDuration = durationInput ? parseInt(durationInput.value) * 1000 : 120000; // default 2 menit

      movePhoto(photo.id, fadeoutDuration);
      
      photoCount++;
    }
    
    
    function movePhoto(photoId, fadeoutDuration) {
      const photo = document.getElementById(photoId);
      if(photo===null){
          return false;
      }
      const screenWidth = window.innerWidth;
      const screenHeight = window.innerHeight;
      
      const randomX = Math.floor(Math.random() * (screenWidth - parseInt(photo.style.width, 10))); 
      const randomY = Math.floor(Math.random() * (screenHeight - parseInt(photo.style.height, 10))); 
      
      photo.style.transform = `translate(${randomX}px, ${randomY}px)`;
      
      setTimeout(() => {
        fadeOutPhoto(photo.id);
      }, fadeoutDuration);

      setTimeout(() => {
        movePhoto(photoId, fadeoutDuration);
      }, speed); // Menggerakkan foto sesuai kecepatan yang diatur
    }

    function resizePhoto(size) {
      const photos = document.querySelectorAll('.photo');
      photos.forEach(photo => {
        const currentWidth = parseInt(photo.style.width, 10) || 100;
        const currentHeight = parseInt(photo.style.height, 10) || 100;

        if (size === 'small') {
          photo.style.width = `${Math.max(currentWidth - 20, 50)}px`;
          photo.style.height = `${Math.max(currentHeight - 20, 50)}px`;
        } else if (size === 'medium') {
          photo.style.width = '150px';
          photo.style.height = '150px';
        } else if (size === 'large') {
          photo.style.width = `${Math.min(currentWidth + 20, 300)}px`;
          photo.style.height = `${Math.min(currentHeight + 20, 300)}px`;
        } else if (size === 'fulllarge') {
          photo.style.width = `${Math.min(currentWidth + 20, 300)}px`;
          photo.style.height = `${Math.min(currentHeight + 20, 300)}px`;
        }
      });
    }

    function changeSpeed(newSpeed) {
      if (newSpeed === 'slow') {
        speed = 10000; // Kecepatan lambat, diatur dalam milidetik
      } else if (newSpeed === 'fast') {
        speed = 3000; // Kecepatan cepat, diatur dalam milidetik
      }
    }

    function fadeOutPhoto(photoId) {
      const photo = document.getElementById(photoId);
          if(photo!==null){
          photo.style.opacity = '0';
          setTimeout(() => {
            photo.remove();
          }, 2000); // Fading selama 2 detik, sesuaikan dengan kebutuhan Anda
      }
    }

    
    function openmodal(){
    $("#addBubbleModal").modal("show");
 }
    function tutup(){
    $("#addBubbleModal").modal("hide");
 }

  function getRandomColor() {
    const letters = '0123456789ABCDEF';
            let colors = [];
            for (let i = 0; i < 1; i++) {
                let color = '#';
                for (let j = 0; j < 6; j++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                colors.push(color);
            }
            return colors.join(', ');
        }
  function getRandomDirection() {
            const directions = ['to right', 'to left'];
            return directions[Math.floor(Math.random() * directions.length)];
        }
  function gra(){
            const startColor = getRandomColor();
            const endColor = getRandomColor();
            const direction = getRandomDirection();

            const gradientBox = document.getElementById('gradient-box');
            gradientBox.style.background = `linear-gradient(${direction}, ${startColor}, ${endColor})`;

            document.body.style.background = `linear-gradient(${direction}, ${startColor}, ${endColor})`;
    
  }
   
    
   // Function to change the background when an image file is selected
function changeBackground(event) {
  const fileInput = event.target;
  const file = fileInput.files[0];
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      document.body.style.backgroundImage = `url('${e.target.result}')`;
      document.body.style.backgroundSize = "cover";
    };
    reader.readAsDataURL(file);
  }
}

// Set initial background image from 'images/background.png' in public folder
document.body.style.backgroundImage = "url('images/background.png')";
document.body.style.backgroundSize = "cover";

  

var sumber=false;


function hapusAngkaDanSimbol(string) {
  // Ekspresi reguler untuk mencocokkan huruf dan spasi
  let regex = /[a-zA-Z\s]/g;
  
  // Menggunakan metode replace() untuk mengganti semua karakter yang tidak cocok dengan string kosong
  let stringHanyaHurufDanSpasi = string.replace(/[^a-zA-Z\s]/g, '');

  return stringHanyaHurufDanSpasi;
}

        var isSpeaking = false;
         let voices = [];
        function populateVoiceList() {
            voices = window.speechSynthesis.getVoices();
        }

        function aktifSuaraKomen(text) {
              var suara_filter = hapusAngkaDanSimbol(text);
                let jumlahKarakter = suara_filter.length;
                if(jumlahKarakter<5){
                   return false;
               }
   
   
   
            // Hentikan suara yang sedang berbicara
            if (isSpeaking) { 
                return false;
            }
            
            isSpeaking = true;

            // Ambil teks dari textarea
         
            var utterance = new SpeechSynthesisUtterance(text);

            // Setel parameter suara
            utterance.lang = 'id-ID'; // Bahasa Indonesia
            utterance.pitch = 1; // Nada
            utterance.rate = 1; // Kecepatan
            utterance.volume = 1; // Volume

            // Pilih suara dari daftar suara yang tersedia
            const indonesianVoice = voices.find(voice => voice.lang === 'id-ID');
            if (indonesianVoice) {
                utterance.voice = indonesianVoice;
            } else {
                console.warn('Suara bahasa Indonesia tidak ditemukan.');
            }

            // Tambahkan event listener untuk mengetahui kapan teks selesai dibunyikan
            utterance.onend = function(event) {
                 isSpeaking=false;
            };

            // Mulai berbicara
            window.speechSynthesis.speak(utterance);
 
        }

        // Pastikan suara sudah dimuat sebelum memanggil speak()
        window.speechSynthesis.onvoiceschanged = function() {
            populateVoiceList();
        };

        
        populateVoiceList();
        
 

function aktifSuara(suaras,jenis){

      var suara_ =  suaras.toLowerCase();
      let suar = suara_.replace(/cara/g, "metode");
      let suara = suar.replace(/kontol/g, "");
      
      var vgift = document.getElementById("vgift");
      if (vgift.checked && jenis=="gift") {
        if(responsiveVoice.isPlaying() && sumber!=true) {
          responsiveVoice.cancel();
        }
        sumber = true;
      
          if(!responsiveVoice.isPlaying()) {
            sumber = true;
            bunyi(suara,jenis);  
            }else{
              sumber=true;
              setTimeout(() => {
                sumber=true;
                bunyi(suara,jenis);
              }, 2500);
            }   
            
            setTimeout(() => {
          sumber=false;
        }, 15000);

      }  
  
  
      var vkomen = document.getElementById("vkomen");
      if (vkomen.checked && jenis=="komen") {
        if(sumber!=true){
          if(!responsiveVoice.isPlaying()) {
            bunyi(suara,jenis);  
            }
          }  
      }  
   
      var vjoin = document.getElementById("vjoin");
      if (vjoin.checked && jenis=="join") {
        if(sumber!=true){
          if(!responsiveVoice.isPlaying()) {
            bunyi(suara,jenis);  
            }
          }  

      }  
    
      var vshare = document.getElementById("vshare");
      if (vshare.checked && jenis=="share") {
          if(sumber!=true){
          if(!responsiveVoice.isPlaying()) {
            bunyi(suara,jenis);  
            }
          }  
           
      }
  
      var vfollow = document.getElementById("vfollow");
      if (vfollow.checked && jenis=="follow") {
        if(sumber!=true){
          if(!responsiveVoice.isPlaying()) {
            bunyi(suara,jenis);  
            }
          }  
             
      }  
  
   
  
      }


  var vo=1; var asbun="";
  function bunyi(suara,jenis){
    if(asbun==suara){
      return false;
    } 
    asbun=suara;
    if(jenis!="gift" && sumber==true){
      responsiveVoice.cancel();
    }
    if(responsiveVoice.isPlaying()){
      // responsiveVoice.cancel(); 
      return false;
    }else{

      if(vo==1){
               vo=2;
                 voice = "Indonesian Female";
           }else{
               vo=1;
                  voice = "Indonesian Male";
           }

          responsiveVoice.speak(suara, voice, {
            rate: 0.9,
            pitch: 1,
            volume: 3,
            enableEstimationTimeout:false
          });

    }
          
  }

  function reloadMainPageFromIframe() {
  // Mengirim pesan ke halaman utama untuk memuat ulang
  parent.postMessage({
    type: 'reloadMainPage'
  }, '*');
}

// Fungsi untuk melakukan scroll
  function scrollDown() {
    // Menentukan elemen yang akan dijadikan batas scroll
    var stopElement = document.getElementById('stopScroll');

    // Menentukan langkah scroll per interval (misalnya, 5 piksel)
    var scrollStep = 5;

    // Melakukan scroll setiap 10 milidetik
  
      // Menambahkan langkah scroll ke posisi scroll saat ini
      window.scrollBy(0, scrollStep);

  }

   
  setTimeout(() => {
    scrollDown();
  }, 500);

  // Fungsi untuk melakukan scroll ke atas
  function scrollToTop() {
    // Menentukan langkah scroll per interval (misalnya, 5 piksel)
    var scrollStep = -5;

    // Melakukan scroll setiap 10 milidetik
    var scrollInterval = setInterval(function() {
      // Menambahkan langkah scroll ke posisi scroll saat ini
      window.scrollBy(0, scrollStep);

      // Menghentikan scroll saat mencapai bagian atas dokumen
      if (window.scrollY <= 0) {
        clearInterval(scrollInterval);
      }
    }, 10);
  }

  setTimeout(() => {
    if(!modeapp){
    $("#togel").show();
    $("#exit").hide();
  }else{
    $("#togle").show();
    $("#togel").hide();
  }
  }, 500);

  const audioPlayer = document.getElementById('audioPlayer');
        const fileInput = document.getElementById('musik');
        
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            const fileURL = URL.createObjectURL(file);
            audioPlayer.src = fileURL;
            audioPlayer.style.display = 'block';
            audioPlayer.play();
        });


let player;

        function playAudio() {
            const youtubeURL = document.getElementById('youtubeURL').value;
            const videoID = getYoutubeVideoID(youtubeURL);
            const volume = document.getElementById('volumeRange').value;

            player = new YT.Player('player', {
                height: '0',
                width: '0',
                videoId: videoID,
                playerVars: {
                    'autoplay': 1,
                    'controls': 0,
                    'loop': 1,
                    'playlist': videoID
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.setVolume(document.getElementById('volumeRange').value); // Set volume
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                event.target.playVideo(); // Play the video again when it ends
            }
        }

        function getYoutubeVideoID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);

            if (match && match[2].length == 11) {
                return match[2];
            } else {
                return null;
            }
        }

        document.getElementById('volumeRange').addEventListener('input', function() {
            if (player) {
                player.setVolume(this.value);
            }
        });

let rocketsInAirCount = 0;

        function onGift(username, profilePictureUrl, giftImageUrl, overrideEnableAudio) {
    if (rocketsInAirCount > 10) return;
    if (settings.firework_maxFireworks && rocketsInAirCount >= settings.firework_maxFireworks) return;

    // Preload images
    const preLoadImage1 = document.createElement('img');
    preLoadImage1.src = profilePictureUrl;
    document.getElementById('imagePreload').appendChild(preLoadImage1);

    const preLoadImage2 = document.createElement('img');
    preLoadImage2.src = giftImageUrl;
    document.getElementById('imagePreload').appendChild(preLoadImage2);

    // Create the rocket element
    const rocket = document.createElement('div');
    rocket.className = 'rocket';
    rocket.style.backgroundImage = `url(${profilePictureUrl})`;

    // Add z-index for rocket
    const coint = Math.floor(Math.random() * 10000 + 10000);  // Example: generate random coint value
    rocket.style.zIndex = coint;

    // Append the rocket to the body
    const randomOffset = (Math.random() * 40 - 20) + 'vmin';
    rocket.style.setProperty('--rocket-offset', randomOffset);

    document.body.appendChild(rocket);

    const verticalOffset = Math.floor(Math.random() * (75 - 60 + 1) + 60);
    rocket.style.setProperty('--rocket-offset-bottom', (verticalOffset - 2) + "vh");

    // Random duration between 2 and 3 seconds
    rocket.style.setProperty('--rocket-launch-duration', (Math.random() * 1 + 2) + 's');

    // Audio setup for rocket
    const audioRocketStart = new Audio('sounds/firework/rocket_start/rocket_start.mp3');
            audioRocketStart.volume = (settings.firework_soundVolume || 80) / 100 * 0.4;

            audioRocketStart.volume = ((settings.firework_soundVolume || 80) / 100) * 0.4;

            const audioRocketBoom = new Audio('sounds/firework/rocket_boom/rocket_boom.mp3');
audioRocketBoom.volume = (settings.firework_soundVolume || 80) / 100;

            audioRocketBoom.volume = (settings.firework_soundVolume || 80) / 100;

    // Play rocket launch sound
    if (overrideEnableAudio || (!location.href.includes("preview=1") && settings.firework_soundEnabled !== false)) {
        setTimeout(() => {
            audioRocketStart.play();
        }, 300);
    }

    rocketsInAirCount += 1;

    // Trigger explosion animation when rocket reaches the top
    rocket.addEventListener('animationend', (e) => {
        if (e.animationName === 'rocketLaunch') {
            rocket.style.animation = 'rocketExplode 0.2s ease-out forwards';
        }

        if (e.animationName === 'rocketExplode') {
            rocket.style.animation = 'rocketHide 1s ease-out forwards';

            // Create multiple explosion elements (three rings)
            // First ring (only profile pictures)
            for (let i = 0; i < 10; i++) {
                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.borderRadius = '50%';
                explosion.style.backgroundImage = `url(${profilePictureUrl})`;
                explosion.style.setProperty('--x', Math.cos((i / 10) * 2 * Math.PI));
                explosion.style.setProperty('--y', Math.sin((i / 10) * 2 * Math.PI));
                explosion.style.transform = `translate(calc(var(--x) * ${20 + i * 5}vmin), calc(var(--y) * ${20 + i * 5}vmin))`;
                explosion.style.left = `calc(50% + ${randomOffset} - 4vmin)`;
                explosion.style.bottom = verticalOffset + 'vh';
                
                // Add z-index for explosion
                explosion.style.zIndex = coint + 1;

                document.body.appendChild(explosion);

                // Remove explosion after animation ends
                explosion.addEventListener('animationend', () => {
                    document.body.removeChild(explosion);
                });
            }

            // Username color and positioning
            let possibleColors = ['#ffcc00', '#ff9d00', '#ff4d00', '#88ff00', '#00ccff', '#ff00b3'];
            const textLabel = document.createElement('div');

            if (settings.firework_showUsername !== false) {
                textLabel.style.setProperty('--username-rotate', Math.floor(Math.random() * 20 - 10) + 'deg');
                textLabel.innerText = username;
                textLabel.style.position = 'absolute';
                textLabel.style.left = `calc(50% + ${randomOffset} - 4vmin)`;
                textLabel.style.bottom = verticalOffset + 'vh';
                textLabel.style.color = possibleColors[Math.floor(Math.random() * possibleColors.length)];

                // Add z-index for textLabel (username)
                textLabel.style.zIndex = coint + 2;
            }

            if (username.length > 30) textLabel.style['font-size'] = '3vmin';
            else if (username.length > 15) textLabel.style['font-size'] = '5vmin';
            else if (username.length > 12) textLabel.style['font-size'] = '7vmin';
            else if (username.length > 8) textLabel.style['font-size'] = '9vmin';
            else if (username.length > 5) textLabel.style['font-size'] = '13vmin';
            else if (username.length > 3) textLabel.style['font-size'] = '15vmin';
            else textLabel.style['font-size'] = '18vmin';

            textLabel.classList.add('username');
            document.body.appendChild(textLabel);

            // Second ring (mixed profile pictures and gifts)
            setTimeout(() => {
                for (let i = 0; i < 10; i++) {
                    const explosion = document.createElement('div');
                    explosion.className = 'explosion';
                    explosion.style.borderRadius = '50%';
                    explosion.style.backgroundImage = i % 2 === 0 ? `url(${profilePictureUrl})` : `url(${giftImageUrl})`;
                    explosion.style.setProperty('--x', Math.cos((i / 10) * 2 * Math.PI));
                    explosion.style.setProperty('--y', Math.sin((i / 10) * 2 * Math.PI));
                    explosion.style.transform = `translate(calc(var(--x) * ${20 + i * 5}vmin), calc(var(--y) * ${20 + i * 5}vmin))`;
                    explosion.style.left = `calc(50% + ${randomOffset} - 4vmin)`;
                    explosion.style.bottom = verticalOffset + 'vh';

                    // Add z-index for second explosion ring
                    explosion.style.zIndex = coint + 3;

                    document.body.appendChild(explosion);

                    // Remove explosion after animation ends
                    explosion.addEventListener('animationend', () => {
                        document.body.removeChild(explosion);
                    });
                }
            }, 400);

            // Third ring (only gifts)
            setTimeout(() => {
                for (let i = 0; i < 10; i++) {
                    const explosion = document.createElement('div');
                    explosion.className = 'explosion';
                    explosion.style.borderRadius = '50%';
                    explosion.style.backgroundImage = `url(${giftImageUrl})`;
                    explosion.style.setProperty('--x', Math.cos((i / 10) * 2 * Math.PI));
                    explosion.style.setProperty('--y', Math.sin((i / 10) * 2 * Math.PI));
                    explosion.style.transform = `translate(calc(var(--x) * ${25 + i * 5}vmin), calc(var(--y) * ${25 + i * 5}vmin))`;
                    explosion.style.left = `calc(50% + ${randomOffset} - 4vmin)`;
                    explosion.style.bottom = verticalOffset + 'vh';

                    // Add z-index for third explosion ring
                    explosion.style.zIndex = coint + 4;

                    document.body.appendChild(explosion);

                    // Remove explosion after animation ends
                    explosion.addEventListener('animationend', () => {
                        document.body.removeChild(explosion);
                    });
                }
            }, 800);

            setTimeout(() => {
                document.body.removeChild(rocket);
                document.body.removeChild(textLabel);
                preLoadImage1.remove();
                preLoadImage2.remove();
            }, 8000);

            setTimeout(() => {
                rocketsInAirCount += -1;
                console.log("rockets in air count", rocketsInAirCount);
            }, 2000);

            if (overrideEnableAudio || (!location.href.includes("preview=1") && settings.firework_soundEnabled !== false)) {
                setTimeout(() => {
                    audioRocketBoom.play();
                }, 200);
            }
        }
    });
}
        