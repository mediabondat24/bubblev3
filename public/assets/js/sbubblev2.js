var array_doa = [
    "tahun ini dapat rezeki yang melimpah", "bisa liburan ke luar negeri", "impianmu terwujud lebih cepat", "tahun depan punya usaha sendiri", "semakin bijaksana dalam menghadapi masalah", "tahun ini bisa bantu orang tua lebih banyak", "diberikan rezeki yang luar biasa", "setiap langkahmu selalu diberkahi", "segala cita-cita terwujud dalam waktu dekat", "selalu dipertemukan dengan orang baik", "bulan depan gajimu naik", "dapat kesempatan bisnis yang besar", "kebeli rumah di daerah impian", "tahun ini lebih bahagia dari tahun lalu", "selalu sehat dan kuat", "diberikan jalan kemudahan dalam usaha", "selalu mendapatkan kebahagiaan sejati", "tahun ini sukses dalam segala hal", "segera dapat proyek besar", "tahun depan punya kendaraan impian", "selalu dilimpahi kedamaian dalam hidup", "segera jadi pengusaha sukses", "kehidupan lebih sukses dan berkah", "tahun depan punya rumah sendiri", "dapat karier yang lebih baik", "diangkat jadi atasan yang dihormati", "selalu dilindungi dalam setiap langkah", "kehidupan menjadi lebih sejahtera", "selalu diberikan rasa syukur yang besar", "tahun ini bisa umroh bersama keluarga", "tahun depan punya usaha franchise", "di tahun ini dapat kesempatan baru", "diberikan kebahagiaan yang tak terhingga", "kehidupan penuh dengan keberkahan", "tahun ini bisa melanjutkan studi ke luar negeri", "selalu dipenuhi dengan cinta dan kasih", "tahun depan punya rumah yang nyaman", "diberikan keberkahan dalam setiap rezeki", "dalam hidup selalu diberi jalan keluar", "selalu diberkahi dengan rezeki yang halal", "selalu bisa menjaga kesehatan tubuh dan jiwa", "tahun ini bisa menyelesaikan semua utang", "selalu diberikan kesabaran dalam menghadapi ujian", "diberikan kesempatan untuk berbakti lebih banyak", "selalu dikelilingi orang-orang yang mencintai", "selalu sukses dalam setiap usaha", "selalu diberi kepercayaan dalam bekerja", "diberikan kekuatan dalam setiap ujian hidup", "selalu dikelilingi kebaikan dan kebahagiaan", "di tahun ini mendapat kesempatan emas", "mendapatkan kebahagiaan sejati", "diberikan kelancaran dalam berbisnis", "semoga selalu diberi petunjuk dalam hidup", "setiap pekerjaan dilancarkan dengan mudah", "mampu mencapai tujuan hidup yang mulia", "tahun ini bisa berlibur ke destinasi impian", "selalu mendapatkan kebahagiaan keluarga", "diberi rezeki yang cukup untuk berbagi", "diberikan kesempatan untuk beribadah lebih baik", "kehidupan penuh berkah dan kebahagiaan", "tahun ini bisa melunasi semua hutang", "mendapatkan kesuksesan di setiap langkah", "setiap hari lebih baik dan berkah", "kehidupan penuh rasa syukur dan kebahagiaan", "mendapatkan pasangan yang setia dan baik hati", "tahun depan punya kebun yang luas", "diberikan kesehatan yang sempurna", "selalu diberikan perlindungan yang terbaik", "kehidupan semakin bahagia dan sukses", "dapat proyek besar yang menguntungkan", "diberikan jalan untuk mencapai impian", "diberikan kesempatan berkolaborasi dengan orang hebat", "selalu dilimpahi kebahagiaan", "selalu diberikan kesempatan untuk berbagi", "mendapatkan peluang kerja yang lebih baik", "setiap usaha diberkahi dan lancar", "selalu dilindungi dan diberkahi oleh Allah", "mendapatkan rezeki yang penuh berkah", "setiap impian dan harapan segera tercapai", "selalu diberikan kebahagiaan yang tak terhingga", "tahun ini bisa berinvestasi dengan cerdas", "mendapatkan teman-teman yang loyal dan bijaksana", "selalu diberi kebahagiaan dalam keluarga", "tahun depan bisa membeli tanah impian", "selalu diberkahi dengan kelancaran rezeki", "diberikan kemampuan untuk membantu orang lain", "selalu diberkahi dengan kedamaian", "kehidupan selalu penuh dengan kebaikan", "tahun ini bisa membuka usaha sendiri", "selalu diberi kesempatan untuk memperbaiki diri", "mendapatkan kesempatan untuk berbagi lebih banyak", "selalu diberkahi dengan cinta dan kebahagiaan"
  ];

  var array_sambutan = [
    "yang selalu bikin hari-hari cerah", "yang suka banget jadi pusat perhatian", "yang punya koleksi foto aneh", "yang hobi banget ngadain maraton film", "yang kadang lebih mirip hibernasi daripada manusia", "yang kalau makan selalu pesan ekstra nasi", "yang kalau jajan nggak pernah lihat harga", "yang bisa tidur berjam-jam tanpa merasa bersalah", "yang selalu pakai baju yang nggak cocok cuaca", "yang nggak bisa hidup tanpa wifi", "yang bisa ngobrol non-stop dari pagi sampai malam", "yang hobinya curhat di grup chat", "yang bisa ngabisin waktu berjam-jam cuma buat scroll TikTok", "yang nggak pernah ketinggalan nonton drama terbaru", "yang jagonya ngedate tapi sering cancel", "yang kalau disuruh kerja malah mikirin makan", "yang selalu punya alasan buat nggak kerja", "yang suka banget bikin kejutan untuk orang lain", "yang tiap pagi nggak pernah ketinggalan ngopi", "yang suka banget nge-gym tapi lebih sering melamun di sana", "yang selalu nyari alasan buat ngeluh", "yang nggak bisa lepas dari drama kehidupan orang lain", "yang sering banget lupa password", "yang selalu bilang ‘besok mulai diet’ tapi baru makan siang tadi", "yang hobinya berdebat tentang hal-hal nggak penting", "yang senang banget ngasih saran, padahal belum tentu benar", "yang kalau udah ngomong, nggak ada yang bisa stop", "yang hobinya jadi juru masak pas lagi lapar", "yang suka banget ikut trend tapi cepat bosan", "yang selalu nyari alasan buat ngedate tapi nggak jadi-jadi", "yang bisa tidur lebih lama dari yang lain", "yang hobinya beli barang yang nggak diperlukan", "yang nggak bisa tidur tanpa musik", "yang kalau pergi ke tempat ramai, langsung bingung mau ngapain", "yang nggak bisa lihat makanan enak tanpa coba", "yang hobinya belanja, tapi selalu lupa bawa uang", "yang hobinya jalan-jalan keliling kota tanpa tujuan", "yang selalu bawa 3 tas sekaligus ke mana-mana", "yang tiap kali lihat harga makanan langsung galau", "yang selalu merasa butuh liburan padahal baru pulang liburan", "yang sukanya makan malam berat, tapi bilang 'diet mulai besok'", "yang suka banget dengerin lagu nostalgia", "yang selalu telat bangun tapi gak pernah telat makan", "yang hobinya cuma tidur dan nonton", "yang nggak bisa lepas dari cemilan apapun", "yang selalu bilang ‘nanti aja’ tapi gak pernah dilakuin", "yang suka banget bikin rencana, tapi nggak pernah dimulai", "yang selalu punya cara untuk menghindari kerjaan", "yang nggak bisa berhenti nonton YouTube", "yang kalau lihat barang lucu langsung beli", "yang kalau lihat baju langsung pengen beli", "yang hobinya ngelamun sambil scroll timeline", "yang suka banget ngegosip di waktu senggang", "yang bisa ngobrol seharian tanpa henti", "yang sering banget kehilangan kunci rumah", "yang kalau ketemu makanan enak langsung kaget", "yang senangnya berbelanja online daripada keluar rumah", "yang hobinya pakai filter lucu di foto", "yang selalu bilang ‘udah capek’ tapi gak mau tidur", "yang hobinya tidur siang, walaupun udah tidur malam", "yang kalau punya uang lebih, langsung beli camilan", "yang hobi banget ngumpulin stiker lucu", "yang nggak bisa makan tanpa sambel", "yang selalu bikin rencana tapi nggak pernah dijalankan", "yang nggak bisa lepas dari gadget", "yang hobi banget ngumpul bareng teman", "yang selalu kaget kalau lihat harga barang mahal", "yang sering bilang ‘capek banget’ tapi langsung pergi nongkrong", "yang selalu bilang ‘males banget’ tapi langsung bangun kalau ada makanan", "yang sering banget lupa kalau sudah makan", "yang hobinya foto-foto tanpa tujuan jelas", "yang suka banget bilang ‘nanti aja’ padahal nggak dikerjain", "yang selalu mikirin makan saat kerja", "yang kadang suka ngeluh, tapi tetep lanjut jalan", "yang suka banget berimajinasi, tapi jarang beraksi", "yang kalau nonton film suka nyari alur cerita yang aneh", "yang selalu bawa 5 barang penting ke mana-mana", "yang hobinya beli barang murah tapi nggak pernah pakai", "yang suka banget nonton live streaming orang lain", "yang nggak bisa lepas dari kopi, walaupun sudah ngopi 5 kali", "yang selalu pengen liburan, tapi di rumah aja", "yang kadang sering bilang ‘sebentar’ tapi berjam-jam baru datang", "yang suka banget minum es krim walaupun musim hujan", "yang selalu nyari alasan buat nggak mandi", "yang hobinya beli makanan untuk foto, tapi nggak dimakan", "yang sering bilang ‘gak punya uang’ tapi belanja terus", "yang hobinya nonton drama dengan bantal di pelukan", "yang suka banget tidur di tempat yang empuk", "yang selalu cari diskon, walaupun cuma 5%"
];


//let backendUrl   =   "https://bubblefoto.online";//"https://tiktok-chat-reader.zerody.one/";//"https://tiktok-ws-cepi.zerody.one/";
let backendUrl = location.protocol === 'file:' ? "https://tiktok-chat-reader.zerody.one/" : undefined;
let connection = new TikTokIOConnection(backendUrl);

// Counter
let viewerCount = 0;
let likeCount = 0;
let diamondsCount = 0;

// These settings are defined by obs.html
if (!window.settings) window.settings = {};

window.addEventListener('DOMContentLoaded', (event) => {
      // Menunggu halaman dimuat, lalu tampilkan modal
      var myModal = new bootstrap.Modal(document.getElementById('basicModal'));
      myModal.show();  // Tampilkan modal secara otomatis
    });


$(document).ready(() => {
    $('#connectButton').click(connect);
    $('#uniqueIdInput').on('keyup', function (e) {
        if (e.key === 'Enter') {
            connect();
        }
    });

    if (window.settings.username) connect();
})

// Function to toggle fullscreen mode
function toggleFullScreen() {
  const doc = window.document;
  const docEl = doc.documentElement;

  const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
  const exitFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

  // Check if fullscreen is already active
  if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
    // Not in fullscreen, request fullscreen
    requestFullScreen.call(docEl);
  }
  // If fullscreen is already active, don't call fullscreen again
}

// Modal close function
$('#closeModalButton').click(function() {
  $('#basicModal').modal('hide');  // Hide modal on close
});


function connect() {
   let uniqueId = window.settings.username || $('#uniqueIdInput').val();
    
    
    if (uniqueId !== '') {
        
        $('#stateText').text('Mohon tunggu jangan klik apapun dulu...');

        connection.connect(uniqueId, {
            enableExtendedGiftInfo: true
        }).then(state => {
            $('#stateText').text(`Berhasil dikoneksikan`);
            inputphoto();
            aktifSuara("Berhasil di koneksikan ke akun "+uniqueId);
            
           // Only request fullscreen if not already in fullscreen
      if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
        setTimeout(() => {
          toggleFullScreen();  // Make fullscreen after modal is fully closed
        }, 200);  // Delay a little to ensure fullscreen is applied
      }

      $('#basicModal').modal('hide');  // Hide the modal after fullscreen

      // Scroll to top after modal closes
      $('#basicModal').on('hidden.bs.modal', function () {
        window.scrollTo(0, 0);  // Scroll to top after modal is fully closed
      });


            viewerCount = 0;
            likeCount = 0;
            diamondsCount = 0;
            updateRoomStats();

        }).catch(errorMessage => {
            if(errorMessage=="Error: LIVE has ended"){
                $('#stateText').html("Gagal! tiktok <b>"+uniqueId+"</b> harus dalam keadaan LIVE.");
            }else if(errorMessage=="Error: Request failed with status code 429"){
                $('#stateText').text("Mohon maaf server sedang gangguan silahkan coba beberapa saat lagi. ");
            }else if(errorMessage=="Error: Request failed with status code 500"){
                $('#stateText').text("Mohon maaf server sedang gangguan silahkan coba beberapa saat lagi. ");
            }else{
                $('#stateText').text(errorMessage);
            }

            // schedule next try if obs username set
            if (window.settings.username) {
                setTimeout(() => {
                    connect(window.settings.username);
                }, 30000);
            }
        })

    } else {
        alert('no username entered');
    }
}
// Prevent Cross site scripting (XSS)
function sanitize(text) {
    return text.replace(/</g, '&lt;')
}

function updateRoomStats() {
    $('#roomStats').html(`Viewers: <b>${viewerCount.toLocaleString()}</b> Likes: <b>${likeCount.toLocaleString()}</b> Earned Diamonds: <b>${diamondsCount.toLocaleString()}</b>`)
}

function generateUsernameLink(data) {
    return `<a class="usernamelink" href="https://www.tiktok.com/@${data.uniqueId}" target="_blank">${data.uniqueId}</a>`;
}

function isPendingStreak(data) {
    return data.giftType === 1 && !data.repeatEnd;
}

// Logika untuk menambah chat item dengan foto profil kecil
function addChatItem(color, data, text, summarize='',komen=false) {
    return false;
    const inputString = sanitize(text);
    let container = location.href.includes('obs.html') ? $('.eventcontainer') : $('.chatcontainer');
      
    if (container.find('div').length > 500) {
        container.find('div').slice(0, 200).remove();
    }

    container.find('.temporary').remove();


if(komen==false || komen=="joined" || komen==""){
    var hasil = ""; var awalan = "";
}else{
        aktifSuaraKomen(data.comment);

}
    container.prepend(`
        <div    class=${summarize ? 'temporary' : 'static'}>
         <a target="new" href="javascript:ganti_bg('"${data.profilePictureUrl}"')">
            <img class="miniprofilepicture" src="${data.profilePictureUrl}">
            <span>
                <b>${generateUsernameLink(data)}</b>
                ${awalan} : <span style="color:${color}">${sanitize(text)}</span>  <i>${hasil}</i>
            </span>
        </a>    
        </div>
    `);
}

// Fungsi untuk menambah gambar profil saat gift diberikan, ukuran sesuai diamond
function addGiftItem(data) {
    
}

// Event handlers
connection.on('roomUser', (msg) => {
    if (typeof msg.viewerCount === 'number') {
        viewerCount = msg.viewerCount;
        updateRoomStats();
    }
})

connection.on('like', (msg) => {
    if (typeof msg.totalLikeCount === 'number') {
        likeCount = msg.totalLikeCount;
        updateRoomStats();
    }

    if (window.settings.showLikes === "0") return;

    if (typeof msg.likeCount === 'number') {
    //    addChatItem('#447dd4', msg, msg.label.replace('{0:user}', '').replace('likes', `${msg.likeCount} likes`),"","joined");
    addBubble("small",msg.profilePictureUrl);
    }
})

// Member join
var urut_sifat=0;
let joinMsgDelay = 0;
connection.on('member', (msg) => {
    if (window.settings.showJoins === "0") return;

    let addDelay = 250;
    if (joinMsgDelay > 500) addDelay = 100;
    if (joinMsgDelay > 1000) addDelay = 0;

    joinMsgDelay += addDelay;
    // gift(msg.profilePictureUrl,msg.nickname,false,false);
    // setTimeout(() => {
        joinMsgDelay -= addDelay;
        // addChatItem('#21b2c2', msg, 'joined', true,"joined");
        addBubble("small",msg.profilePictureUrl);
       
      
        

         
        
        let jumlahElemen = array_sambutan.length;
       if(urut_sifat>=(jumlahElemen-1)){
        urut_sifat=1;
       }else{
        urut_sifat++;
       }
       var sifat =  array_sambutan[urut_sifat];
       var string = msg.nickname;
       var nama = string.replace(/[^a-zA-Z]/g, '');

       var opsi = $("#opsi_suara").val();
       if(opsi==1){
           aktifSuara("halo kak "+nama+" "+sifat,"join");
       }else{
           aktifSuara("selamat bergabung kak "+nama,"join");
       }



    // }, joinMsgDelay);
})

// New chat comment received
connection.on('chat', (msg) => {
    if (window.settings.showChats === "0") return;
  //  gift(msg.profilePictureUrl,msg.nickname,false,false,"chat",msg.comment);
   // addChatItem('', msg, msg.comment,'',true);
     aktifSuaraKomen(msg.comment);
            // openPopupTab(``,`${msg.comment}`);
            addBubble("small",msg.profilePictureUrl);
            addBubble("small",msg.profilePictureUrl);
           
})
// Variabel untuk menyimpan data pemberi gift
let giftGivers = {};



// Fungsi untuk mendapatkan top 5 pemberi gift
function getTopGivers() {
    return Object.entries(giftGivers)
        .sort(([, a], [, b]) => b.total_diamonds - a.total_diamonds) // Urutkan berdasarkan total_diamonds
        .slice(0, 3) // Ambil top 3
        .map(([uniqueId, data], index) => ({
            rank: `TOP ${index + 1}`, // Rank berdasarkan urutan
            nickname: data.nickname, // Ambil nickname dari data pengguna
            profilePictureUrl: data.profilePictureUrl,
            diamondCount: data.total_diamonds
        }));
}


var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta', '#2F4F4F', '#1E90FF', '#CD5C5C', '#20B2AA', '#C71585', '#DDA0DD', '#9ACD32'];

// Fungsi untuk memilih warna acak
function getRandomColor() {
    return colors[Math.floor(Math.random() * colors.length)];
}

function updateRunningText() {
    const topGivers = getTopGivers();
    const runningTextContainer = document.querySelector('.running-text-container');
    const runningText = document.querySelector('.running-text');

    // Kosongkan kontainer sebelum menambah konten baru
    runningText.innerHTML = "";

    // Tambahkan header teks
    const headerText = document.createElement('h2');
    headerText.textContent = 'TOP LIVE';
    headerText.style.fontSize = '20px'; 
    headerText.style.fontWeight = 'bold';  // Menambahkan efek bold
    headerText.style.marginTop = '95px';
    runningText.appendChild(headerText);

    // Periksa status checkbox dari DOM
    const checkbox = document.getElementById('toggle-diamond-points');
    const showDiamondPoints = checkbox ? checkbox.checked : true;

    // Tambahkan setiap top giver
    topGivers.forEach((giver, index) => {
        const giverDiv = document.createElement('div');
        giverDiv.className = `top-giver top-${index + 1}`;

        const giverContentDiv = document.createElement('div');
        giverContentDiv.className = 'top-giver-content';

        const rankSpan = document.createElement('strong');
        rankSpan.className = 'top-giver-rank';
        rankSpan.textContent = `${giver.rank}`;
        rankSpan.style.textShadow = `0 0 5px ${getRandomColor()}, 0 0 5px ${getRandomColor()}`;
        rankSpan.style.marginBottom = '10px';

        const profilePicImg = document.createElement('img');
        profilePicImg.src = giver.profilePictureUrl;
        profilePicImg.className = 'profile-img'; // Menambahkan kelas profile-img
        profilePicImg.style.width = '80px';
        profilePicImg.style.height = '80px';
        profilePicImg.style.borderRadius = '50%';
        profilePicImg.style.border = '3px solid ' + getRandomColor();
        profilePicImg.style.boxShadow = '0 0 10px ' + getRandomColor();
        profilePicImg.style.position = 'relative'; // Agar z-index berfungsi

        const crownImg = document.createElement('img');
        crownImg.src = '/images/animatetop.gif'; // Gambar maskot baru
        crownImg.className = 'crown'; // Terapkan kelas crown
        crownImg.style.position = 'absolute'; // Letakkan di atas profil
        crownImg.style.top = '20px';
        crownImg.style.left = '50%';
        crownImg.style.transform = 'translateX(-50%)'; // Agar gambar terletak di tengah
        crownImg.style.width = '98px'; // Ukuran crown
        crownImg.style.height = '98px'; // Ukuran crown
        crownImg.style.zIndex = '0'; // Samakan z-index dengan foto profil

        const nicknameSpan = document.createElement('span');
        nicknameSpan.textContent = `${giver.nickname}`;
        nicknameSpan.style.textShadow = `0 0 5px ${getRandomColor()}, 0 0 5px ${getRandomColor()}`;
        nicknameSpan.style.marginTop = '2px'; // Jarak antara foto profil dan nickname

        const diamondPointsSpan = document.createElement('span');
        diamondPointsSpan.className = 'diamond-points';
        diamondPointsSpan.textContent = `${giver.diamondCount} points`;
        diamondPointsSpan.style.textShadow = `0 0 5px ${getRandomColor()}, 0 0 3px ${getRandomColor()}`;
        diamondPointsSpan.style.display = showDiamondPoints ? 'block' : 'none';

        giverContentDiv.appendChild(rankSpan);
        giverContentDiv.appendChild(profilePicImg);
        giverContentDiv.appendChild(nicknameSpan);
        giverContentDiv.appendChild(diamondPointsSpan);
        giverDiv.appendChild(giverContentDiv);

        // Menambahkan crown di atas foto profil
        giverDiv.appendChild(crownImg);

        runningText.appendChild(giverDiv);
    });
    // Jika ada top 1, tambahkan gambar besar di dalam kontainer
    // Jika ada top 1, tambahkan gambar besar di dalam kontainer
if (topGivers.length > 0) {
    const top1Giver = topGivers[0];
    let top1Container = document.querySelector('.top-1-container');

    // Jika kontainer tidak ada, buat kontainer baru
    if (!top1Container) {
        top1Container = document.createElement('div');
        top1Container.className = 'top-1-container float-up-down'; // Menambahkan kelas float-up-down
        top1Container.style.textAlign = 'center'; // Styling opsional
        top1Container.style.marginTop = '50px';
        document.body.appendChild(top1Container);
    }

    // Kosongkan kontainer sebelum menambahkan elemen baru
    top1Container.innerHTML = '';

    const top1Img = document.createElement('img');
    top1Img.src = top1Giver.profilePictureUrl; // Gambar profile top 1
    top1Img.className = 'profile-img'; // Menambahkan kelas profile-img
    top1Img.className = 'top-1-img'; // Terapkan kelas untuk styling gambar

    // Terapkan border acak pada gambar top 1
    top1Img.style.border = '2px solid ' + getRandomColor();
    top1Img.style.boxShadow = '0 0 10px ' + getRandomColor();
    top1Img.style.width = '90px'; // Ukuran gambar opsional
    top1Img.style.height = '90px'; // Ukuran gambar opsional
    top1Img.style.borderRadius = '50%'; // Styling agar berbentuk lingkaran
    top1Img.style.marginTop = '68px';
    
    // Tambahkan gambar ke dalam kontainer
    top1Container.appendChild(top1Img);

    // Tambahkan gambar crown
    const crownImg = document.createElement('img');
    crownImg.src = '/images/maskot.gif'; // Gambar maskot
    crownImg.className = 'crown'; // Terapkan kelas crown
    top1Container.appendChild(crownImg);
    // Memanggil fungsi makeDraggable untuk top1Container
        makeDraggable(top1Container);
}


    // Tampilkan pesan jika belum ada pemberi gift
    if (topGivers.length === 0) {
        runningText.innerHTML = "Belum ada pemberi gift, ayo jadi yang pertama!";
    }
    // Memanggil fungsi makeDraggable untuk runningTextContainer
    makeDraggable(runningTextContainer);
    addFlipAnimation();
    // Tambahkan event listener untuk checkbox (jika belum ditambahkan)
    if (checkbox) {
        checkbox.addEventListener('change', () => {
            const diamondPoints = document.querySelectorAll('.diamond-points');
            diamondPoints.forEach(span => {
                span.style.display = checkbox.checked ? 'inline' : 'none';
            });
        });
    }
    
}

//fungsi flip
function addFlipAnimation() {
    // Memilih semua gambar profil dengan kelas profile-img di dalam running-text-container dan top-1-container
    const profileImages = document.querySelectorAll('.running-text-container .profile-img, .top-1-container .profile-img');
    
    profileImages.forEach((img) => {
        // Menghapus kelas animasi flip yang ada sebelumnya
        img.classList.remove('flip-right', 'flip-left');
        
        // Menentukan arah animasi flip secara acak (flip-right atau flip-left)
        const randomDirection = Math.random() > 0.5 ? 'flip-right' : 'flip-left';
        
        // Menambahkan kelas animasi flip yang dipilih
        img.classList.add(randomDirection);
    });
}

// Tambahkan animasi setiap 6 detik
addFlipAnimation();
setInterval(addFlipAnimation, 3000);




//fungsi geser 
function makeDraggable(element) {
    let isDragging = false;
    let startY = 0;

    // Mouse Events
    element.addEventListener("mousedown", (event) => {
        isDragging = true;
        startY = event.clientY - element.offsetTop;
        element.style.cursor = "grabbing";

        // Mencegah scroll saat dragging
        event.preventDefault();
    });

    document.addEventListener("mousemove", (event) => {
        if (!isDragging) return;
        element.style.top = `${event.clientY - startY}px`;

        // Mencegah scroll saat dragging
        event.preventDefault();
    });

    document.addEventListener("mouseup", () => {
        isDragging = false;
        element.style.cursor = "grab";
    });

    // Touch Events
    element.addEventListener("touchstart", (event) => {
        isDragging = true;
        startY = event.touches[0].clientY - element.offsetTop;
        element.style.cursor = "grabbing";

        // Mencegah scroll saat dragging
        event.preventDefault();
    }, { passive: false }); // Agar event.preventDefault() bisa bekerja

    document.addEventListener("touchmove", (event) => {
        if (!isDragging) return;
        element.style.top = `${event.touches[0].clientY - startY}px`;

        // Mencegah scroll saat dragging
        event.preventDefault();
    }, { passive: false });

    document.addEventListener("touchend", () => {
        isDragging = false;
        element.style.cursor = "grab";
    });
}




// New gift received
var urut_doa = 0;
connection.on('gift', (data) => {
   if (!isPendingStreak(data) && data.diamondCount > 0) {
        const { uniqueId, nickname, profilePictureUrl, diamondCount, repeatCount } = data;
        const diamonds = diamondCount * repeatCount; // Hitung total diamond

        


        // Update atau tambahkan ke giftGivers (logika lokal)
        if (giftGivers[uniqueId]) {
    giftGivers[uniqueId].total_diamonds += diamonds;
} else {
    giftGivers[uniqueId] = { uniqueId, nickname, profilePictureUrl, total_diamonds: diamonds };
}


        // Perbarui tampilan
        updateRunningText();
        updateRoomStats();
    }

    if (window.settings.showGifts === "0") return;
     
    // addGiftItem(data);
    // gift(data.profilePictureUrl,data.nickname,true);

    if (!data.repeatEnd) {
        
   
    if(data.diamondCount<=5){
        
        for(i=1;i<=data.diamondCount;i++)
        {
            addBubble("medium",data.profilePictureUrl,data.diamondCount);
            // addBubble("small",data.profilePictureUrl);
            // addBubble("small",data.profilePictureUrl);
        }
        
    estopAudio(0);
        eplayAudio(0);
        
    }else if(data.diamondCount<=10){
        
         setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        for(i=1;i<=5;i++)
        {
            addBubble("medium",data.profilePictureUrl,data.diamondCount); 
        }
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
         
        for(i=1;i<=5;i++)
        {
            addBubble("small",data.profilePictureUrl);
        }
        estopAudio(0);
        estopAudio(1);
        eplayAudio(1);
    }else if(data.diamondCount<=20){
        bgklip(data.profilePictureUrl,data.diamondCount);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);

        for(i=1;i<=5;i++)
        {
            addBubble("medium",data.profilePictureUrl,data.diamondCount); 
        }
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount);  
         
        for(i=1;i<=20;i++)
        {
            addBubble("small",data.profilePictureUrl);
        }
        //supersmall
        addBubble("supersmall",data.profilePictureUrl,data.diamondCount);
        addBubble("supersmall",data.profilePictureUrl,data.diamondCount);
        estopAudio(0);
        estopAudio(1);
        estopAudio(2);
        eplayAudio(2);
    }else if(data.diamondCount<=30){
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 3000);
        for(i=1;i<=5;i++)
        {
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
        
  

        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount); 
        addBubble("large",data.profilePictureUrl,data.diamondCount); 

       
    
         
        for(i=1;i<=25;i++)
        {
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount);
        }
        bgklip(data.profilePictureUrl,data.diamondCount);
        estopAudio(0);
        estopAudio(1);
        estopAudio(2);
         estopAudio(3);
        eplayAudio(3);
    }else if(data.diamondCount<=50){
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 3000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 4000);
        for(i=1;i<=10;i++)
        {
             addBubble("large",data.profilePictureUrl,data.diamondCount); 
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
      
        
           
        
        
        for(i=1;i<=40;i++)
        {
 
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount); 
        }
        bgklip(data.profilePictureUrl,data.diamondCount);
         estopAudio(0);
        estopAudio(1);
        estopAudio(2);
         estopAudio(3);
        eplayAudio(3);
    }else if(data.diamondCount<=100){
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    },3000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 3000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 4000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 4000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 5000);
        
        for(i=1;i<=20;i++)
        {
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
        
        for(i=1;i<=15;i++)
        {
             addBubble("large",data.profilePictureUrl,data.diamondCount);  
        }
        
        
                
        
        
        for(i=1;i<=40;i++)
        {
            
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount); 
        }
        
         bgklip(data.profilePictureUrl,data.diamondCount);
          estopAudio(0);
        estopAudio(1);
        estopAudio(2);
        estopAudio(3);
        estopAudio(4);
        eplayAudio(4);
    }else if(data.diamondCount<=300){
        
          
          setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 3000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 3000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 4000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 4000); 
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 5000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 5000); 
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 6000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 6000);    
                    
        for(i=1;i<=25;i++)
        {
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
        
        for(i=1;i<=20;i++)
        {
             addBubble("large",data.profilePictureUrl,data.diamondCount);  
        }
        
         
        
        
        for(i=1;i<=40;i++)
        {
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount); 
        }
        bgklip(data.profilePictureUrl,data.diamondCount);
          estopAudio(0);
        estopAudio(1);
        estopAudio(2);
        estopAudio(3);
        estopAudio(4);
        estopAudio(5);
        eplayAudio(5);
    }else{
        
         
                    
       for(i=1;i<=35;i++)
        {
            addBubble("supermedium",data.profilePictureUrl,data.diamondCount); 
        }
        
        
                 
        
        for(i=1;i<=30;i++)
        {
             addBubble("large",data.profilePictureUrl,data.diamondCount);  
        }
       setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 1000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 2000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 3000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 3000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 4000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 4000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 5000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 5000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 6000);
        setTimeout(function() {
        onGift(data.nickname, data.profilePictureUrl, data.giftPictureUrl, true)
    }, 6000);
        bgklip(data.profilePictureUrl,data.diamondCount);
        
        for(i=1;i<=50;i++)
        {
            addBubble("supersmall",data.profilePictureUrl,data.diamondCount); 
        }
          estopAudio(0);
        estopAudio(1);
        estopAudio(2);
        estopAudio(3);
        estopAudio(4);
        estopAudio(5);
        eplayAudio(5);
    }



   
     

      let jumlahElemen = array_doa.length;
      if(urut_doa>=(jumlahElemen-1)){
        urut_doa=1;
      }else{
        urut_doa++;
      }
      var doa= array_doa[urut_doa];

      var string = data.nickname;
      var nama = string;//.replace(/[^a-zA-Z]/g, '');


      var opsi = $("#opsi_suara").val();
      if(opsi==1){
        aktifSuara("Terimakasih kak "+nama+"  sudah kasih "+data.giftName+" semoga "+doa+".","gift");
      }else{
        aktifSuara("Terimakasih kak "+nama+"  sudah kasih "+data.giftName+" semoga berkah","gift");
      }


          
    




        }     
})

// share, follow
connection.on('social', (data) => {
    if (window.settings.showFollows === "0") return;

    let color = data.displayType.includes('follow') ? '#ff005e' : '#2fb816';
    if(color=='#ff005e'){
        aktifSuara("Terimakasih kak "+data.nickname+"  sudah jadikan aku teman","follow");
        addBubble("small",data.profilePictureUrl);
    }else{
        aktifSuara("Terimakasih kak "+data.nickname+"  sudah sherr","share");
        addBubble("small",data.profilePictureUrl);
    }
 
})




function inputphoto(){
  var img = "images/bubble.gif";
  addBubble("small",img);
  addBubble("small",img);
  addBubble("small",img);
 
}

       
var no =1;
var jawab = "xmxmxmmx";
var alias = "xmxmxmmx";
var koin=0;
var mode = "soal";

 
$(".chatcontainer").show();
$(".chatcontainer2").hide();
$(".chatcontainer3").hide();
function jawaban(komentar,poto,nama){
     
  
} 

 var ganti=true;
 
 function okey(foto,nama,g=false){
   
   
        $("#namas").html(nama);
        var element = document.getElementById("g");
        element.src= foto;  
         
        
 }

 function bahaya(){
  var element = document.getElementById("g");
        element.src= "images/bubble.gif"; 
 }
 
 
      var start=true;
      
      function jo(){
         if(start==true){
             start=false;
         }else{
               start=true;
         }
      }

    function hapus_class(){
      $("#g").hide(300);
      $("#g").show(1000);
    }  

    function add_class(){
      $("#g").hide(300);
      $("#g").show(1000);
    }  
      
     function gift(foto,nama,sts=false,g=false,ket=null,kom=null,jml_coin=1){
      var gift = document.getElementById("gift");
if (gift.checked) {
  var opsi_gift = true;
} else {
  var opsi_gift = false;
}

var follow = document.getElementById("follow");
if (follow.checked) {
  var opsi_follow = true;
} else {
  var opsi_follow = false;
}

var share = document.getElementById("share");
if (share.checked) {
  var opsi_share = true;
} else {
  var opsi_share = false;
}

var like = document.getElementById("like");
if (like.checked) {
  var opsi_like = true;
} else {
  var opsi_like = false;
}

var join = document.getElementById("join");
if (join.checked) {
  var opsi_join = true;
} else {
  var opsi_join = false;
}
var key = document.getElementById("key");
if (key.checked) {
  var opsi_key = true;
} else {
  var opsi_key = false;
}

 
         if(sts==true && ganti==true){
          console.log("jml"+jml_coin);
        var min_coin = $("[name='min_coin']").val();
        console.log("min"+min_coin);
     

          if(jml_coin>=min_coin){
                ganti=false;
                if(opsi_gift==true){
                  
                  add_class();

                  okey(foto,nama,g); 
                  setTimeout(() => {
                                    ganti=true;
                      },7000);
                      return true;
                }else{
                  ganti=true;
                }
            }
                
         }
         
          if(sts==true && ganti==false){ 
            console.log("jml"+jml_coin);
var min_coin = $("[name='min_coin']").val();
console.log("min"+min_coin);


            if(jml_coin>=min_coin){
              if(opsi_gift==true){
                add_class();

                  setTimeout(() => {
                        okey(foto,nama,g); 
                  
                    },5000);
                    
                    setTimeout(() => {
                                  ganti=true;
                    },10000);
                  }else{
                    ganti=true;
                  }
              }
               
          }
          
    if(ket=="like" && opsi_like==true)      
    {      
            if(sts==false && ganti==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }

   else if(ket=="share" && opsi_share==true)      
    {      
            if(sts==false && ganti==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }

   else if(ket=="follow" && opsi_follow==true)      
    {      
            if(sts==false && ganti==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }
    else if(ket=="join" && opsi_join==true)      
    {      
            if(sts==false && ganti==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }
    else if(ket=="chat" && opsi_key==true)      
    {      
      var komentar_system = kom;
           var komen_status = false;
             var keyword = $("[name='komentar']").val();
              const isKeywordExists = komentar_system.toLowerCase().includes(keyword.toLowerCase());
              if(isKeywordExists!=false){ 
                var komen_status = true;
              }else if(keyword==""){
                var komen_status = true;
              }
            if(sts==false && ganti==true && komen_status==true){ 
              hapus_class();
                            okey(foto,nama); 
                                    ganti=true; 
            }
    }
     
     }
         

 let photoCount = 0;
    let speed = 5000; // Kecepatan default, diatur dalam milidetik

    function addBubble(size,img,coint=1) {



      const photo = document.createElement('img');
      photo.src = img; // Ganti dengan nama foto Anda
      photo.classList.add('photo');
      // photo.id = `photo-${photoCount}`;
      photo.id = `photo-${photoCount}`;
      photo.setAttribute('onclick', 'toggleBlur(this)');


      
const container = document.getElementById('animation-container');
container.appendChild(photo);

      let durationInput;
   
    
    if (size === 'small') {
        photo.style.width = '50px';
        photo.style.height = '50px';
        durationInput = document.getElementById('smallDuration');
        var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        photo.style.zIndex = coint;

      } else if (size === 'medium') {
        photo.style.width = '120px';
        photo.style.height = '120px';
        durationInput = document.getElementById('mediumDuration');
        photo.style.zIndex = coint+1;
        
        var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        
      }else if (size === 'large') {
        photo.style.width = '250px';
        photo.style.height = '250px';
        durationInput = document.getElementById('largeDuration');
        photo.style.zIndex = coint+2;
        
        var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        
      }else if (size === 'supermedium') {
        photo.style.width = '120px';
        photo.style.height = '120px';
        photo.style.borderRadius = '240px';
        durationInput = document.getElementById('mediumDuration');
        photo.style.zIndex = coint;
       var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        
      }else if (size === 'supersmall') {
        photo.style.width = '70px';
        photo.style.height = '70px';
        photo.style.borderRadius = '240px';
        durationInput = document.getElementById('smallDuration');
        photo.style.zIndex = coint+1;
        var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta','orange','#2F4F4F','#1E90FF','#CD5C5C','#20B2AA','#C71585','#DDA0DD','#9ACD32']; 
        var randomColor = colors[Math.floor(Math.random() * colors.length)]; 
        photo.style.border = '2px solid ' + randomColor;
        
      }
      
      const fadeoutDuration = durationInput ? parseInt(durationInput.value) * 1000 : 120000; // default 2 menit

      movePhoto(photo.id, fadeoutDuration);
      
      photoCount++;
    }
    
    
    function movePhoto(photoId, fadeoutDuration) {
      const photo = document.getElementById(photoId);
      if(photo===null){
          return false;
      }
      const screenWidth = window.innerWidth;
      const screenHeight = window.innerHeight;
      
      const randomX = Math.floor(Math.random() * (screenWidth - parseInt(photo.style.width, 10))); 
      const randomY = Math.floor(Math.random() * (screenHeight - parseInt(photo.style.height, 10))); 
      
      photo.style.transform = `translate(${randomX}px, ${randomY}px)`;
      
      setTimeout(() => {
        fadeOutPhoto(photo.id);
      }, fadeoutDuration);

      setTimeout(() => {
        movePhoto(photoId, fadeoutDuration);
      }, speed); // Menggerakkan foto sesuai kecepatan yang diatur
    }


    function resizePhoto(size) {
      const photos = document.querySelectorAll('.photo');
      photos.forEach(photo => {
        const currentWidth = parseInt(photo.style.width, 10) || 100;
        const currentHeight = parseInt(photo.style.height, 10) || 100;

        if (size === 'small') {
          photo.style.width = `${Math.max(currentWidth - 20, 50)}px`;
          photo.style.height = `${Math.max(currentHeight - 20, 50)}px`;
        } else if (size === 'medium') {
          photo.style.width = '150px';
          photo.style.height = '150px';
        } else if (size === 'large') {
          photo.style.width = `${Math.min(currentWidth + 20, 300)}px`;
          photo.style.height = `${Math.min(currentHeight + 20, 300)}px`;
        } else if (size === 'fulllarge') {
          photo.style.width = `${Math.min(currentWidth + 20, 300)}px`;
          photo.style.height = `${Math.min(currentHeight + 20, 300)}px`;
        }
      });
    }

    function changeSpeed(newSpeed) {
      if (newSpeed === 'slow') {
        speed = 10000; // Kecepatan lambat, diatur dalam milidetik
      } else if (newSpeed === 'fast') {
        speed = 3000; // Kecepatan cepat, diatur dalam milidetik
      }
    }

    function fadeOutPhoto(photoId) {
      const photo = document.getElementById(photoId);
          if(photo!==null){
          photo.style.opacity = '0';
          setTimeout(() => {
            photo.remove();
          }, 2000); // Fading selama 2 detik, sesuaikan dengan kebutuhan Anda
      }
    }

    
   

function getRandomColor() {
    const letters = '0123456789ABCDEF';
            let colors = [];
            for (let i = 0; i < 1; i++) {
                let color = '#';
                for (let j = 0; j < 6; j++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                colors.push(color);
            }
            return colors.join(', ');
        }
  function getRandomDirection() {
            const directions = ['to right', 'to left'];
            return directions[Math.floor(Math.random() * directions.length)];
        }
  function gra(){
            const startColor = getRandomColor();
            const endColor = getRandomColor();
            const direction = getRandomDirection();

            const gradientBox = document.getElementById('gradient-box');
            gradientBox.style.background = `linear-gradient(${direction}, ${startColor}, ${endColor})`;

            document.body.style.background = `linear-gradient(${direction}, ${startColor}, ${endColor})`;
    
  }
   
    
   // Function to change the background when an image file is selected
function changeBackground(event) {
  const fileInput = event.target;
  const file = fileInput.files[0];
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      document.body.style.backgroundImage = `url('${e.target.result}')`;
      document.body.style.backgroundSize = "cover";
    };
    reader.readAsDataURL(file);
  }
}

// Set initial background image from 'images/background.png' in public folder
document.body.style.backgroundImage = "url('images/background.png')";
document.body.style.backgroundSize = "cover";

  

var sumber=false;


function hapusAngkaDanSimbol(string) {
  // Ekspresi reguler untuk mencocokkan huruf dan spasi
  let regex = /[a-zA-Z\s]/g;
  
  // Menggunakan metode replace() untuk mengganti semua karakter yang tidak cocok dengan string kosong
  let stringHanyaHurufDanSpasi = string.replace(/[^a-zA-Z\s]/g, '');

  return stringHanyaHurufDanSpasi;
}

        var isSpeaking = false;
         let voices = [];
        function populateVoiceList() {
            voices = window.speechSynthesis.getVoices();
        }

        function aktifSuaraKomen(text) {
              var suara_filter = hapusAngkaDanSimbol(text);
                let jumlahKarakter = suara_filter.length;
                if(jumlahKarakter<5){
                   return false;
               }
   
   
   
            // Hentikan suara yang sedang berbicara
            if (isSpeaking) { 
                return false;
            }
            
            isSpeaking = true;

            // Ambil teks dari textarea
         
            var utterance = new SpeechSynthesisUtterance(text);

            // Setel parameter suara
            utterance.lang = 'id-ID'; // Bahasa Indonesia
            utterance.pitch = 1; // Nada
            utterance.rate = 1; // Kecepatan
            utterance.volume = 1; // Volume

            // Pilih suara dari daftar suara yang tersedia
            const indonesianVoice = voices.find(voice => voice.lang === 'id-ID');
            if (indonesianVoice) {
                utterance.voice = indonesianVoice;
            } else {
                console.warn('Suara bahasa Indonesia tidak ditemukan.');
            }

            // Tambahkan event listener untuk mengetahui kapan teks selesai dibunyikan
            utterance.onend = function(event) {
                 isSpeaking=false;
            };

            // Mulai berbicara
            window.speechSynthesis.speak(utterance);
 
        }

        // Pastikan suara sudah dimuat sebelum memanggil speak()
        window.speechSynthesis.onvoiceschanged = function() {
            populateVoiceList();
        };

        
        populateVoiceList();
        
 

function aktifSuara(suaras,jenis){

      var suara_ =  suaras.toLowerCase();
      let suar = suara_.replace(/cara/g, "metode");
      let suara = suar.replace(/kontol/g, "");
      
      var vgift = document.getElementById("vgift");
      if (vgift.checked && jenis=="gift") {
        if(responsiveVoice.isPlaying() && sumber!=true) {
          responsiveVoice.cancel();
        }
        sumber = true;
      
          if(!responsiveVoice.isPlaying()) {
            sumber = true;
            bunyi(suara,jenis);  
            }else{
              sumber=true;
              setTimeout(() => {
                sumber=true;
                bunyi(suara,jenis);
              }, 2500);
            }   
            
            setTimeout(() => {
          sumber=false;
        }, 15000);

      }  
  
  
      var vkomen = document.getElementById("vkomen");
      if (vkomen.checked && jenis=="komen") {
        if(sumber!=true){
          if(!responsiveVoice.isPlaying()) {
            bunyi(suara,jenis);  
            }
          }  
      }  
   
      var vjoin = document.getElementById("vjoin");
      if (vjoin.checked && jenis=="join") {
        if(sumber!=true){
          if(!responsiveVoice.isPlaying()) {
            bunyi(suara,jenis);  
            }
          }  

      }  
    
      var vshare = document.getElementById("vshare");
      if (vshare.checked && jenis=="share") {
          if(sumber!=true){
          if(!responsiveVoice.isPlaying()) {
            bunyi(suara,jenis);  
            }
          }  
           
      }
  
      var vfollow = document.getElementById("vfollow");
      if (vfollow.checked && jenis=="follow") {
        if(sumber!=true){
          if(!responsiveVoice.isPlaying()) {
            bunyi(suara,jenis);  
            }
          }  
             
      }  
  
   
  
      }


  var vo=1; var asbun="";
  function bunyi(suara,jenis){
    if(asbun==suara){
      return false;
    } 
    asbun=suara;
    if(jenis!="gift" && sumber==true){
      responsiveVoice.cancel();
    }
    if(responsiveVoice.isPlaying()){
      // responsiveVoice.cancel(); 
      return false;
    }else{

      if(vo==1){
               vo=2;
                 voice = "Indonesian Female";
           }else{
               vo=1;
                  voice = "Indonesian Male";
           }

          responsiveVoice.speak(suara, voice, {
            rate: 0.9,
            pitch: 1,
            volume: 3,
            enableEstimationTimeout:false
          });

    }
          
  }






 const audioPlayer = document.getElementById('audioPlayer');
        const fileInput = document.getElementById('musik');
        
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            const fileURL = URL.createObjectURL(file);
            audioPlayer.src = fileURL;
            audioPlayer.style.display = 'block';
            audioPlayer.play();
        });



 let player;

        function playAudio() {
            const youtubeURL = document.getElementById('youtubeURL').value;
            const videoID = getYoutubeVideoID(youtubeURL);
            const volume = document.getElementById('volumeRange').value;

            player = new YT.Player('player', {
                height: '0',
                width: '0',
                videoId: videoID,
                playerVars: {
                    'autoplay': 1,
                    'controls': 0,
                    'loop': 1,
                    'playlist': videoID
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.setVolume(document.getElementById('volumeRange').value); // Set volume
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                event.target.playVideo(); // Play the video again when it ends
            }
        }

        function getYoutubeVideoID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);

            if (match && match[2].length == 11) {
                return match[2];
            } else {
                return null;
            }
        }

        document.getElementById('volumeRange').addEventListener('input', function() {
            if (player) {
                player.setVolume(this.value);
            }
        });

var sebelumnya = 0;
    function bgklip(link,diamon) {
   
          var kk = document.getElementById("klapklipid");
      if (!kk.checked) {
        return false;
      }
      
        if(diamon>=sebelumnya){
        sebelumnya=diamon;
                    const existingImage = document.getElementById('imageContainer');
                    if (existingImage) {
                        existingImage.remove();
                    }

        }else{
              const existingImage = document.getElementById('imageContainer');
                    if (existingImage) {
                        return false;
                    }
             sebelumnya=diamon;
        }

        if(diamon<=20){
            var detik = 500;
        }else if(diamon<=30){
            var detik = 8000;
        }else if(diamon<=50){
            var detik = 15000;
        }else if(diamon<=100){
            var detik = 20000;
        }else if(diamon<=200){
            var detik = 25000;
        }else{
            var detik = 35000;
        }

     
        const imageContainer = document.createElement('div');
        imageContainer.id = 'imageContainer';
        imageContainer.className = 'image-container-bg';

        const img = document.createElement('img');
        img.classList.add('img-bg');
        img.src = link;
        img.alt = 'Contoh Gambar';

        imageContainer.appendChild(img);
        document.body.appendChild(imageContainer);

        imageContainer.classList.add('fullscreenBG');

        setTimeout(() => {
            if (imageContainer.parentNode) {
                imageContainer.remove();
            }
        }, detik); // Menghapus gambar setelah 15 detik
    }

     let rocketsInAirCount = 0;

        function onGift(username, profilePictureUrl, giftImageUrl, overrideEnableAudio) {
    if (rocketsInAirCount > 10) return;
    if (settings.firework_maxFireworks && rocketsInAirCount >= settings.firework_maxFireworks) return;

    // Preload images
    // const preLoadImage1 = document.createElement('img');
    // preLoadImage1.src = profilePictureUrl;
    // document.getElementById('animation-container').appendChild(preLoadImage1);

    // const preLoadImage2 = document.createElement('img');
    // preLoadImage2.src = giftImageUrl;
    // document.getElementById('animation-container').appendChild(preLoadImage2);
    // **(Tambahan baru) - Array warna untuk border**
    var colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple', 'cyan', 'magenta', 'orange', '#2F4F4F', '#1E90FF', '#CD5C5C', '#20B2AA', '#C71585', '#DDA0DD', '#9ACD32'];
    var randomColor = colors[Math.floor(Math.random() * colors.length)]; 

    // Create the rocket element
    const rocket = document.createElement('div');
    rocket.className = 'rocket';
    rocket.style.backgroundImage = `url(${profilePictureUrl})`;
    // **(Tambahan baru) - Menambahkan border warna-warni ke rocket**
    rocket.style.border = `1px solid ${randomColor}`; 

    // Add z-index for rocket
    const coint = Math.floor(Math.random() * 10000 + 10000);  // Example: generate random coint value
    rocket.style.zIndex = coint;

    // Append the rocket to the body
    const randomOffset = (Math.random() * 40 - 20) + 'vmin';
    rocket.style.setProperty('--rocket-offset', randomOffset);

    document.body.appendChild(rocket);

    const verticalOffset = Math.floor(Math.random() * (75 - 60 + 1) + 60);
    rocket.style.setProperty('--rocket-offset-bottom', (verticalOffset - 2) + "vh");

    // Random duration between 2 and 3 seconds
    rocket.style.setProperty('--rocket-launch-duration', (Math.random() * 1 + 2) + 's');

    // Audio setup for rocket
    const audioRocketStart = new Audio('sounds/firework/rocket_start/rocket_start.mp3');
            audioRocketStart.volume = (settings.firework_soundVolume || 80) / 100 * 0.4;

            audioRocketStart.volume = ((settings.firework_soundVolume || 80) / 100) * 0.4;

            const audioRocketBoom = new Audio('sounds/firework/rocket_boom/rocket_boom.mp3');
audioRocketBoom.volume = (settings.firework_soundVolume || 80) / 100;

            audioRocketBoom.volume = (settings.firework_soundVolume || 80) / 100;

    // Play rocket launch sound
    if (overrideEnableAudio || (!location.href.includes("preview=1") && settings.firework_soundEnabled !== false)) {
        setTimeout(() => {
            audioRocketStart.play();
        }, 300);
    }

    rocketsInAirCount += 1;

    // Trigger explosion animation when rocket reaches the top
    rocket.addEventListener('animationend', (e) => {
        if (e.animationName === 'rocketLaunch') {
            rocket.style.animation = 'rocketExplode 0.2s ease-out forwards';
        }

        if (e.animationName === 'rocketExplode') {
            rocket.style.animation = 'rocketHide 1s ease-out forwards';

            // Create multiple explosion elements (three rings)
            // First ring (only profile pictures)
            for (let i = 0; i < 10; i++) {
                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.borderRadius = '50%';
                explosion.style.backgroundImage = `url(${profilePictureUrl})`;
                explosion.style.setProperty('--x', Math.cos((i / 10) * 2 * Math.PI));
                explosion.style.setProperty('--y', Math.sin((i / 10) * 2 * Math.PI));
                explosion.style.transform = `translate(calc(var(--x) * ${20 + i * 5}vmin), calc(var(--y) * ${20 + i * 5}vmin))`;
                explosion.style.left = `calc(50% + ${randomOffset} - 4vmin)`;
                explosion.style.bottom = verticalOffset + 'vh';

                 // **(Tambahan baru) - Hanya foto profil yang memiliki border warna-warni**
                explosion.style.border = `1px solid ${colors[Math.floor(Math.random() * colors.length)]}`;
                
                // Add z-index for explosion
                explosion.style.zIndex = coint + 1;

                document.body.appendChild(explosion);

                // Remove explosion after animation ends
                explosion.addEventListener('animationend', () => {
                    document.body.removeChild(explosion);
                });
            }

            // Username color and positioning
            let possibleColors = ['#ffcc00', '#ff9d00', '#ff4d00', '#88ff00', '#00ccff', '#ff00b3'];
            const textLabel = document.createElement('div');

            if (settings.firework_showUsername !== false) {
                textLabel.style.setProperty('--username-rotate', Math.floor(Math.random() * 20 - 10) + 'deg');
                textLabel.innerText = username;
                textLabel.style.position = 'absolute';
                textLabel.style.left = `calc(50% + ${randomOffset} - 4vmin)`;
                textLabel.style.bottom = verticalOffset + 'vh';
                textLabel.style.color = possibleColors[Math.floor(Math.random() * possibleColors.length)];

                // Add z-index for textLabel (username)
                textLabel.style.zIndex = coint + 2;
            }

            if (username.length > 30) textLabel.style['font-size'] = '3vmin';
            else if (username.length > 15) textLabel.style['font-size'] = '5vmin';
            else if (username.length > 12) textLabel.style['font-size'] = '7vmin';
            else if (username.length > 8) textLabel.style['font-size'] = '9vmin';
            else if (username.length > 5) textLabel.style['font-size'] = '13vmin';
            else if (username.length > 3) textLabel.style['font-size'] = '15vmin';
            else textLabel.style['font-size'] = '18vmin';

            textLabel.classList.add('username');
            document.body.appendChild(textLabel);

            // Second ring (mixed profile pictures and gifts)
            setTimeout(() => {
                for (let i = 0; i < 10; i++) {
                    const explosion = document.createElement('div');
                    explosion.className = 'explosion';
                    explosion.style.borderRadius = '50%';
                    explosion.style.backgroundImage = i % 2 === 0 ? `url(${profilePictureUrl})` : `url(${giftImageUrl})`;
                    explosion.style.setProperty('--x', Math.cos((i / 10) * 2 * Math.PI));
                    explosion.style.setProperty('--y', Math.sin((i / 10) * 2 * Math.PI));
                    explosion.style.transform = `translate(calc(var(--x) * ${20 + i * 5}vmin), calc(var(--y) * ${20 + i * 5}vmin))`;
                    explosion.style.left = `calc(50% + ${randomOffset} - 4vmin)`;
                    explosion.style.bottom = verticalOffset + 'vh';
                    // **(Tambahan baru) - Tentukan apakah gambar ini profil atau hadiah**
                    const isProfile = i % 2 === 0;
                    explosion.style.backgroundImage = isProfile ? `url(${profilePictureUrl})` : `url(${giftImageUrl})`;

                    // **Hanya beri border jika explosion menggunakan foto profil**
                    if (isProfile) {
                        explosion.style.border = `1px solid ${colors[Math.floor(Math.random() * colors.length)]}`;
                    }
                    // Add z-index for second explosion ring
                    explosion.style.zIndex = coint + 3;

                    document.body.appendChild(explosion);

                    // Remove explosion after animation ends
                    explosion.addEventListener('animationend', () => {
                        document.body.removeChild(explosion);
                    });
                }
            }, 400);

            // Third ring (only gifts)
            setTimeout(() => {
                for (let i = 0; i < 10; i++) {
                    const explosion = document.createElement('div');
                    explosion.className = 'explosion';
                    explosion.style.borderRadius = '50%';
                    explosion.style.backgroundImage = `url(${giftImageUrl})`;
                    explosion.style.setProperty('--x', Math.cos((i / 10) * 2 * Math.PI));
                    explosion.style.setProperty('--y', Math.sin((i / 10) * 2 * Math.PI));
                    explosion.style.transform = `translate(calc(var(--x) * ${25 + i * 5}vmin), calc(var(--y) * ${25 + i * 5}vmin))`;
                    explosion.style.left = `calc(50% + ${randomOffset} - 4vmin)`;
                    explosion.style.bottom = verticalOffset + 'vh';
                    // **(Tambahan baru) - Tentukan apakah gambar ini profil atau hadiah**
                    const isProfile = i % 2 === 0;
                    explosion.style.backgroundImage = isProfile ? `url(${profilePictureUrl})` : `url(${giftImageUrl})`;

                    // **Hanya beri border jika explosion menggunakan foto profil**
                    if (isProfile) {
                        explosion.style.border = `1px solid ${colors[Math.floor(Math.random() * colors.length)]}`;
                    }
                    // Add z-index for third explosion ring
                    explosion.style.zIndex = coint + 4;

                    document.body.appendChild(explosion);

                    // Remove explosion after animation ends
                    explosion.addEventListener('animationend', () => {
                        document.body.removeChild(explosion);
                    });
                }
            }, 800);

            setTimeout(() => {
                document.body.removeChild(rocket);
                document.body.removeChild(textLabel);
                // preLoadImage1.remove();
                // preLoadImage2.remove();
            }, 8000);

            setTimeout(() => {
                rocketsInAirCount += -1;
                console.log("rockets in air count", rocketsInAirCount);
            }, 2000);

            if (overrideEnableAudio || (!location.href.includes("preview=1") && settings.firework_soundEnabled !== false)) {
                setTimeout(() => {
                    audioRocketBoom.play();
                }, 200);
            }
        }
    });
}

// Menetapkan file musik yang sudah ada di folder /public/music/
        const audioElements = [
    new Audio('/music/upin.mp3'),  // Musik untuk Gift kecil
    new Audio('/music/1.mp3'),  // Musik untuk Gift kecil
    new Audio('/music/2.mp3'),  // Musik untuk Gift kecil
    new Audio('/music/3.mp3'),  // Musik untuk Gift kecil
    new Audio('/music/4.mp3'),  // Musik untuk Gift kecil
    new Audio('/music/5.mp3'),  // Musik untuk Gift kecil
    
];

// Menetapkan gambar GIF yang sesuai dengan audio
const imageElements = [
    '/images/0.gif',      // GIF untuk Gift kecil mawar 0
    '/images/1.gif',      // GIF untuk Gift kecil mawar 0
    '/images/2.gif',      // GIF untuk Gift sedang  10 1
    '/images/3.gif',      // GIF untuk Gift besar 20 2
    '/images/4.gif',    // GIF untuk Gift super besar 30 3
    '/images/5.gif'     // GIF untuk Gift sadbor 100 4
    
];

// Menetapkan durasi tampilan gambar GIF (dalam detik)
const gifDurations = [
    8,   // Durasi untuk Gift kecil (5 detik)
    4,   // Durasi untuk Gift sedang (4 detik)
    4,   // Durasi untuk Gift besar (6 detik)
    4,   // Durasi untuk Gift super besar (8 detik)
    4,    // Durasi untuk Gift sadbor (7 detik)
    4,    // Durasi untuk Gift sadbor (7 detik)
];

// Fungsi untuk memulai audio dan menampilkan gambar GIF
function eplayAudio(index) {
    // Memulai audio sesuai dengan index yang dipilih
    audioElements[index].play();

    // Menampilkan gambar GIF yang sesuai dengan index yang dipilih
    const gifImage = document.getElementById('gifImage');
    gifImage.src = imageElements[index];  // Menetapkan path gambar GIF
    gifImage.style.display = 'block';     // Menampilkan gambar GIF

    // Menyembunyikan gambar GIF setelah durasi yang telah ditentukan
    setTimeout(() => {
        gifImage.style.display = 'none';  // Menyembunyikan gambar setelah durasi GIF selesai
    }, gifDurations[index] * 1000);     // Durasi dalam milidetik
}

// Fungsi untuk menghentikan audio yang diputar
function estopAudio(index) {
    audioElements[index].pause();
    audioElements[index].currentTime = 0;
}

// Fungsi untuk menghentikan semua audio dan menyembunyikan gambar GIF
function stopAllAudio() {
    audioElements.forEach((audio, index) => {
        estopAudio(index);
    });

    // Menyembunyikan gambar GIF setelah audio berhenti
    const gifImage = document.getElementById('gifImage');
    gifImage.style.display = 'none';  // Menyembunyikan gambar GIF
}

connection.on('streamEnd', () => {
    $('#stateText').text('Stream ended.');

    // schedule next try if obs username set
    if (window.settings.username) {
        setTimeout(() => {
            connect(window.settings.username);
        }, 30000);
    }
})
